const chartHeight=32;let fixedBarCount=49;const optimalValues={},calcSelectors=["retirement-age","expectancy","expected-stocks","expected-bonds","expected-btc","expected-cash","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate",],calcElementsAndRanges=[],inputValues={"btc-price":65e3},onlyNumbers=e=>+String(e).replace(/\D/g,""),formatPercent=e=>`${e}%`,formatToFixed=(e,t=0)=>+e.toFixed(t),formatCurrencyShort=(e,t=0)=>e>=1e12?`$${(e/1e12).toFixed(1)}T`:e>=1e9?`$${(e/1e9).toFixed(1)}B`:e>=1e6?`$${(e/1e6).toFixed(t)}M`:e>=1e3?`$${(e/1e3).toFixed()}K`:`$${e}`,formatCurrency=(e,t=0)=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:t,maximumFractionDigits:t}).format(e),updateRangeSliderScale=(e,t,a,n,r,i,l)=>{let u=(n-a)/(fixedBarCount-1),s=Math.round((r-a)/u);if(l===s)return"#E9EBF2";if(i){if(l<s){let $=(s-l)/s,c=.24+.6*$;return`rgba(57, 158, 106, ${Math.min(c,1)})`}{let p=(l-s)/(fixedBarCount-s),o=.24+.6*p;return`rgba(255, 91, 59, ${Math.min(o,1)})`}}if(l<s){let d=(s-l)/s,V=.24+.6*d;return`rgba(255, 91, 59, ${Math.min(V,1)})`}{let m=(l-s)/(fixedBarCount-s),b=.24+.6*m;return`rgba(57, 158, 106, ${Math.min(b,1)})`}},updateAllRangesliders=()=>{calcElementsAndRanges.forEach(e=>{let{selector:t,slider:a,min:n,max:r,step:i}=e,l=+a.value,u=(r-n)/(fixedBarCount-1),s=optimalValues[t],$=optimalValues[`${t}-reversed`],c=optimalValues[`${t}-bars`];c.attr("fill",(e,t)=>{let a=n+u*t;return updateRangeSliderScale(a,l,n,r,s,$,t)})})},updateHandle=(e,t)=>{let a=document.querySelector(`#${e} .calc__slider__scale__item.is--mid`),n=document.querySelector(`#${e} input[type="range"]`),r=(t-n.min)/(n.max-n.min),i=n.offsetWidth,l=r*i,u=100*r;"true"===a.getAttribute("is-percent")?a.innerText=formatPercent(t):"true"===a.getAttribute("is-usd")?a.innerText=formatCurrencyShort(t):a.innerText=onlyNumbers(t),u>97&&(a.nextElementSibling.style.opacity=0),u<3&&(a.previousElementSibling.style.opacity=0),u>3&&u<97&&(a.nextElementSibling.style.opacity=1,a.previousElementSibling.style.opacity=1),a.style.left=l+"px",a.style.transform=`translateX(-${u}%)`},initRangeSliders=()=>{calcSelectors.forEach(e=>{let t=document.querySelector(`#${e}`);if(!t){console.error(`Slider container not found for selector: ${e}`);return}let a=t.querySelector(".calc__graph");if(!a){console.error(`Graph container not found for selector: ${e}`);return}let n=a.clientWidth,r=window.innerWidth<768?3:4,i=d3.select(a).append("svg").attr("width",n).attr("height",32),l=t.querySelector(".calc__slider-range");if(!l){console.error(`Slider not found for selector: ${e}`);return}l.min,l.max;let u=d3.range(fixedBarCount),s=(n-r*(fixedBarCount-1))/fixedBarCount,$=d3.scaleBand().domain(u).range([0,n]).paddingInner(r/(s+r)),c=i.selectAll("rect").data(u).enter().append("rect").attr("x",e=>$(e)).attr("y",0).attr("width",s).attr("height",32);optimalValues[`${e}-bars`]=c;let p=()=>{let t=+l.value;updateAllRangesliders(),updateHandle(e,t)},o;l.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{let a=l.value;inputValues[e]=onlyNumbers(a),p();let n=t.querySelector(`#${e}-i`);n&&("true"===n.getAttribute("is-percent")?n.value=formatPercent(a):"true"===n.getAttribute("is-usd")?n.value=formatCurrency(a):n.value=onlyNumbers(a)),runCalculations()},10)}),p();let d=()=>{n=a.clientWidth;let e=(n-r*(fixedBarCount-1))/fixedBarCount;$.range([0,n]),c.attr("x",e=>$(e)).attr("width",e),p()},V;window.addEventListener("resize",()=>{clearTimeout(V),V=setTimeout(d,100)});let m=t.querySelector(`#${e}-i`);m&&m.addEventListener("blur",()=>{setTimeout(()=>{inputValues[e]=onlyNumbers(m.value),l.value=onlyNumbers(m.value),p()},10)})})};window.addEventListener("load",()=>{window.innerWidth<768&&(fixedBarCount=35),initRangeSliders(),calcSelectors.forEach(e=>{let t=document.querySelector(`#${e} .calc__slider-range`);calcElementsAndRanges.push({selector:e,slider:t,element:t,min:+t.getAttribute("min"),max:+t.getAttribute("max"),step:+t.getAttribute("step")}),t&&(t.dispatchEvent(new Event("input")),runCalculations())});let e=document.querySelectorAll('.calc-field[is-age="true"]');e.forEach(e=>{let t=+e.getAttribute("max-age"),a=+e.getAttribute("min-age");e.addEventListener("input",()=>e.value=onlyNumbers(e.value)),e.addEventListener("blur",()=>{let n=onlyNumbers(e.value);n>t&&(n=t),n<a&&(n=a),e.value=n,inputValues[e.id]=n;let r=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");r?(r.value=n,r.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"max age: ",t,"min age:",a,"used value: ",n)})});let t=document.querySelectorAll('.calc-field[is-percent="true"]');t.forEach(e=>{let t=+e.getAttribute("max-percent"),a=+e.getAttribute("min-percent");e.addEventListener("blur",()=>{let n=onlyNumbers(e.value);n>t&&(n=t),n<a&&(n=a),e.value=formatPercent(n),inputValues[e.id]=n/100;let r=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");r?(r.value=n,r.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"only numbers: ",onlyNumbers(e.value),"used value: ",n/100)})});let a=document.querySelectorAll('.calc-field[is-usd="true"]');a.forEach(e=>{let t=+e.getAttribute("max-usd"),a=+e.getAttribute("min-usd");e.addEventListener("blur",()=>{let n=onlyNumbers(e.value);n>t&&(n=t),n<a&&(n=a),e.value=formatCurrency(n),inputValues[e.id]=n;let r=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");r?(r.value=n,r.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"only numbers: ",onlyNumbers(e.value),"used value: ",n)})}),document.querySelectorAll(".calc-radio input").forEach(e=>{e.addEventListener("change",()=>{inputValues[e.name]=e.value,runCalculations(),console.log(e.name,"radio value: ",e.value)})}),document.querySelectorAll("input[init-value]").forEach(e=>{e.value=e.getAttribute("init-value"),e.dispatchEvent(new Event("blur")),runCalculations()}),document.querySelectorAll("input[type='radio'][radio-initial='true']").forEach(e=>{e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),runCalculations()}),document.querySelectorAll('.calc-radio input[name="plan-type"]').forEach(e=>{e.addEventListener("change",()=>{let e=document.querySelector('.calc-radio input[name="plan-type"]:checked').value;"custom"===e?document.querySelector("#expected-btc").classList.remove("is--disabled"):document.querySelector("#expected-btc").classList.add("is--disabled")})}),window.dispatchEvent(new Event("resize"))});const btcPricesS2F={2023:83667.67557239954,2024:686398.0127483337,2025:703741.9524243205,2026:721375.6236071566,2027:739301.4262968419,2028:5986997.015654025,2029:6060174.083947013,2030:6133945.0152537,2031:6208312.209574085,2032:49965761.24291532,2033:50266224.53526536,2034:50567889.953642786,2035:50870759.89804761,2036:408181178.5400824,2037:409398694.1478387,2038:410618628.40764976,2039:411840983.7195157,2040:3299624560.159754,2041:3304526099.867491,2042:3309432491.2793384,2043:3314343736.795295,2044:26534409444.738514,2045:26554078710.52289,2046:26573757694.115482,2047:26593446397.916298,2048:212826355165.1583,2049:212905158594.60263,2050:212983981474.06342,2051:213062823805.94064,2052:1704818018138.2832,2053:1705133484741.0745,2054:1705448990258.2983,2055:1705764534692.3552,2056:13647378572031.568,2057:13648640944365.16,2058:13649903394542.018,2059:13651165922564.541,2060:109214377726149.42,2061:109219428227481.05,2062:109224478884513.6,2063:109229529697249.48,2064:873856441296055.4,2065:873876645325528.8,2066:873896849666418.5,2067:873917054318726.8,2068:6991417254093309,2069:6991498074259649,2070:6991578895048836,2071:6991659716460872,2072:0xc6b75053c21058,2073:0xc6b79b99451880,2074:0xc6b7e6dedb22a8,2075:0xc6b83224842ee8,2076:0x635c2be3afeae80,2077:0x635c3eb5201ea00,2078:0x635c518692b2940,2079:0x635c645807a6d00,2080:357985909114264e4,2081:0x31ae3b94bf7da600,2082:0x31ae40491dc4d200,2083:0x31ae44fd7c580600,2084:28639017565401715e3,2085:2863903825633595e4,2086:2863905894728015e4,2087:28639079638234317e3,2088:2291127198697211e5,2089:2291128026335876e5,2090:229112885397474e6,2091:22911296816138034e4,2092:1832904076346728e6,2093:1832904407402453e6,2094:1832904738458218e6,2095:1832905069514023e6,2096:14663241880335521e6,2097:14663243204558938e6,2098:14663244528782437e6,2099:14663245853006015e6,2100:11730597212094267e7,2101:11730597741783739e7,2102:11730598271473226e7,2103:1173059880116273e8,2104:9384479252805988e8,2105:9384479464681798e8,2106:938447967655761e9,2107:9384479888433425e8,2108:7507583995497068e9,2109:7507584080247396e9,2110:7507584164997724e9,2111:7507584249748053e9,2112:6006067433698574e10,2113:60060674675987065e9,2114:6006067501498839e10,2115:6006067535398971e10,2116:48048540418792296e10,2117:48048540554392825e10,2118:4804854068999335e11,2119:4804854082559388e11,2120:38438832714715317e11,2121:3843883276895553e12,2122:38438832823195746e11,2123:3843883287743595e12,2124:3075106632364485e13,2125:3075106634586495e13,2126:3075106636808505e13,2127:3075106639030515e13,2128:2460085306062612e14,2129:2460085306646612e14,2130:2460085307230612e14,2131:2460085307814612e14,2132:19680682457644895e14,2133:19680682458004896e14,2134:19680682458364897e14,2135:19680682458724895e14,2136:15744545966091917e15,2137:15744545966101917e15,2138:15744545966111917e15,2139:15744545966121917e15,2140:12595636772888455e16,2141:12595636772889454e16,2142:12595636772890454e16,2143:12595636772891456e16,2144:10076509418312764e17,2145:10076509418312863e17,2146:10076509418312964e17,2147:10076509418313064e17,2148:806120753465051e19,2149:806120753465052e19,2150:806120753465053e19},btcPricesPowerLaw={2010:.03010628391340072,2011:1.1665179071089278,2012:9.907153518999726,2013:45.19867119834384,2014:146.69756182579547,2015:383.8690959546252,2016:865.7538110434199,2017:1751.2974860018503,2018:3260.172897171796,2019:5684.040358193767,2020:9398.205992247365,2021:14873.644841217618,2022:22689.361763417706,2023:33545.06742296482,2024:48274.150009732526,2025:67856.9259484952,2026:93434.15495479168,2027:126320.80650542538,2028:168020.06620561847,2029:220237.57171875774,2030:284895.86892683443,2031:364149.07984625496,2032:460397.7745621203,2033:576304.0400856528,2034:714806.7396007673,2035:879136.956059804,2036:1072833.6145261182,2037:1299759.2780504897,2038:1564116.11221663,2039:1870462.0138040376,2040:2223726.899298489,2041:2629229.1492358693,2042:3092692.20459768,2043:3620261.3116871836,2044:4218520.412109992,2045:4894509.174658779,2046:5655740.166065894,2047:6510216.157738416,2048:7466447.56572719,2049:8533470.021312093,2050:9720862.069704706,2051:11038762.99447847,2052:12497890.765443347,2053:14109560.10777605,2054:15885700.690305535,2055:17838875.430944793,2056:19982298.91732885,2057:22329855.9408026,2058:24896120.141967528,2059:27696372.76606204,2060:30746621.526514836,2061:34063619.575065486,2062:37664884.57690828,2063:41568717.88935906,2064:45794223.84260448,2065:50361329.121127106,2066:55290802.24446532,2067:60604273.145984486,2068:66324252.848392956,2069:72474153.23477471,2070:79078306.9139389,2071:86161987.17892468,2072:93751428.05753744,2073:101873844.45382282,2074:110557452.37940992,2075:119831489.27368927,2076:129726234.41182208,2077:140273029.3995864,2078:151504298.75413832,2079:163453570.5697123,2080:176155497.2673918,2081:189645876.42804408,2082:203961671.7075677,2083:219141033.83361897,2084:235223321.68296367,2085:252249123.43869257,2086:270260277.82650423,2087:289299895.4292663,2088:309412380.07914644,2089:330643450.3265579,2090:353040160.9852152,2091:376650924.7525929,2092:401525533.90509224,2093:427715182.06731635,2094:455272486.0546629,2095:484251507.78876597,2096:514707776.2849914,2097:546698309.7114946,2098:580281637.519149,2099:615517822.6418598,2100:652468483.7665489,2101:691196817.6723416,2102:731767621.6383815,2103:774247315.91971,2104:818703966.2906268,2105:865207306.6551566,2106:913828761.7238742,2107:964641469.7568666,2108:1017720305.3720078,2109:1073141902.4184024,2110:1130984676.914149,2111:1191328850.0483358,2112:1254256471.2464457,2113:1319851441.2990417,2114:1388199535.5529408,2115:1459388427.1647863,2116:1533507710.416309,2117:1610648924.0909843,2118:1690905574.9117064,2119:1774373161.0388107,2120:1861149195.6284683,2121:1951333230.450664,2122:2045026879.5664902,2123:2142333843.06452,2124:2243359930.8555956,2125:2348213187.2468762,2126:2457003848.429197,2127:2569844421.318914,2128:2686849762.5737424,2129:2808137152.919356,2130:2933826241.2336226,2131:3064039183.7189164,2132:3198900557.6991563,2133:3338537479.274699,2134:3483079594.9370136,2135:3632659358.393442,2136:3787412122.3454347,2137:3947476186.1085377,2138:4112982582.5432158,2139:4284065241.7017865,2140:4460850714.863287,2141:4643468531.0255375,2142:4832041129.041158,2143:5026693943.046582,2144:5227555547.292991,2145:5434757559.012363,2146:5648434824.287295,2147:5868725423.872905,2148:6095760671.162726,2149:6329675264.029956,2150:6570607324.946248},currentYear=new Date().getFullYear(),currentBtcPrice=65e3,btcPricesBtc24=(()=>{let e=currentYear,t={[e]:65e3};for(let a=1;a<=121;a++){let n=Math.max(50-(a-1)*2.5,20),r=t[e+(a-1)],i=e+a;t[i]=r*(1+n/100)}return t})(),btcPricesCustom=e=>{let t={[currentYear]:65e3};for(let a=1;a<=150;a++){let n=t[currentYear+a-1];t[currentYear+a]=n*(1+e/100)}return t},sidebarElements={};document.addEventListener("DOMContentLoaded",()=>{sidebarElements.retireBy=document.querySelector("#res-retire-by"),sidebarElements.portfolioAtRetirement=document.querySelector("#res-portfolio-retirement"),sidebarElements.btcAtRetirement=document.querySelector("#res-btc-retirement"),sidebarElements.btcPriceAtRetirement=document.querySelector("#res-btc-price-retirement"),sidebarElements.monthlyBudget=document.querySelector("#res-budget-monthly"),sidebarElements.annualBudget=document.querySelector("#res-budget-year"),sidebarElements.yearsOfWithdrawals=document.querySelector("#res-years-of-withdrawals"),sidebarElements.portfolioAtDeath=document.querySelector("#res-portfolio-at-death"),sidebarElements.successMessage=document.querySelector('.notification[notification="success"]'),sidebarElements.errorMessage=document.querySelector('.notification[notification="fail"]'),sidebarElements.mobileUnderline=document.querySelector(".calc-mobile__underline")});const runCalculations=()=>{let e=["btc-price","current-age-i","balance-stocks","balance-bonds","balance-btc","balance-other","additional-stocks","additional-bonds","additional-btc","additional-other","retirement-age","expectancy","expected-stocks","expected-bonds","expected-cash","expected-btc","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate","plan-type","btc-account"],t=e.filter(e=>!inputValues[e]&&0!==inputValues[e]);if(t.length>0)return;let a=inputValues["current-age-i"],n=(e,t)=>e[t],r=(e,t)=>e[t],i=(e,t)=>e[t],l=(e,t)=>e[t],u=(e,t)=>e[t],s=(e,t,a)=>{let n=0;for(let r=t;r<=a&&e[r];r++)n++;return n},$=(e,t,a,n=!1,r=!0,i=inputValues["growth-rate"],l=inputValues["inflation-rate"])=>{let u={};u[currentYear]=e;for(let s=1;s<=a;s++){let $=u[currentYear+(s-1)],c=currentYear+s;if(r&&c>t)continue;let p=$*(1+(n?l:i)/100);u[c]=p}return u},c=e=>{let t={};return(t[currentYear]=inputValues["balance-btc"],"btc24"===inputValues["plan-type"])?btcPricesBtc24:"power-law"===inputValues["plan-type"]?btcPricesPowerLaw:"custom"===inputValues["plan-type"]?btcPricesCustom(e):btcPricesS2F},p=(e,t,n,r,i=inputValues["capital-gains"])=>{let l={};for(let u=1;u<=r;u++){let s=currentYear+u,$=a+u,c=$>=60?0:i;if(s>n){let p;p="none"===t?e[s]/(1-c/100):e[s],l[s]=p}else l[s]=0}return l},o=(e,t)=>{let a={};a[currentYear]=inputValues["balance-other"];let n=inputValues["expected-cash"];for(let r=1;r<=t;r++){let i=a[currentYear+(r-1)],l=currentYear+r,u=e[l],s=i*(1+n/100);a[l]=s+u}return a},d=(e,t,a,n,r,i,$)=>{setTimeout(()=>{let c=l(a,currentYear+(inputValues["retirement-age"]-e));sidebarElements.retireBy&&(sidebarElements.retireBy.value=inputValues["retirement-age"]),sidebarElements.portfolioAtRetirement&&(sidebarElements.portfolioAtRetirement.value=formatCurrency($)),sidebarElements.btcAtRetirement&&(sidebarElements.btcAtRetirement.value="â‚¿"+formatCurrency(u(t,currentYear+(inputValues["retirement-age"]-e))/c,3).replace("$","")),sidebarElements.btcPriceAtRetirement&&(sidebarElements.btcPriceAtRetirement.value=formatCurrency(c)),sidebarElements.monthlyBudget&&(sidebarElements.monthlyBudget.value=formatCurrency(n/12)),sidebarElements.annualBudget&&(sidebarElements.annualBudget.value=formatCurrency(n)),sidebarElements.yearsOfWithdrawals&&(sidebarElements.yearsOfWithdrawals.value=formatToFixed(s(r,currentYear+(inputValues["retirement-age"]-e),currentYear-e+inputValues.expectancy),1)),sidebarElements.portfolioAtDeath&&(sidebarElements.portfolioAtDeath.value=formatCurrency(i)),i<=0?(sidebarElements.successMessage.classList.add("hidden"),sidebarElements.errorMessage.classList.remove("hidden"),sidebarElements.mobileUnderline.classList.remove("is--green")):(sidebarElements.successMessage.classList.remove("hidden"),sidebarElements.errorMessage.classList.add("hidden"),sidebarElements.mobileUnderline.classList.add("is--green"))},50)},V=(e,t,a,n,r,i,l,u,s,$,p,o,d=!1)=>{let V={},m={},b={},x={},y={},h={},f={},g={},v=c(o),E={},w={},C=s,Y=$,S=p,A=inputValues["balance-bonds"],k=inputValues["balance-stocks"],B=inputValues["balance-btc"],q=inputValues["balance-other"];V[currentYear]=A+k+B+q,m[currentYear]=B,x[currentYear]=k,h[currentYear]=A,g[currentYear]=q,w[currentYear]=V[currentYear];for(let R=1;R<=l;R++){let L=currentYear+R,P=v[L],F=V[L-1]||0,W=0,D=0,N=0,T=e[L]-t[L]||0;if(L>u&&F>0&&0!==T){let M=m[L-1]||0,I=x[L-1]||0,z=h[L-1]||0;if(F>0){let O=M/F,U=I/F,Z=z/F;W=T*O,D=T*U,N=T*Z,T>0&&(W=Math.min(W,M),D=Math.min(D,I),N=Math.min(N,z))}}if(F>0){b[L]=-W,y[L]=-D,f[L]=-N;let G=P/v[L-1];m[L]=(m[L-1]||0)*G+(a[L]||0)+b[L],x[L]=(x[L-1]||0)*(1+C/100)+(n[L]||0)+y[L],h[L]=(h[L-1]||0)*(1+Y/100)+(r[L]||0)+f[L],g[L]=(g[L-1]||0)*(1+S/100)+(i[L]||0),V[L]=Math.max(m[L]+x[L]+h[L]+g[L]-Math.max(T,0),0)}else m[L]=0,x[L]=0,h[L]=0,g[L]=0,V[L]=0;V[L]<=0?E[L]=!1:E[L]=!0;let H=.6*w[L-1],K=H*(1+C/100)+(n[L]||0)+y[L],X=.4*w[L-1],j=X*(1+Y/100)+(r[L]||0)+f[L];if(L>u){let J=K+j,Q=T*(J/V[L]),ee=.6*Q,et=.4*Q;if(w[L-1]>0&&e[L]<J){let ea=K-ee,en=j-et;w[L]=Math.max(ea+en,0)}else w[L]=0}else w[L]=K+j;isNaN(V[L])&&console.error("NaN detected in year:",L,{btcBalance:m[L],stocksBalance:x[L],bondsBalance:h[L],cashBalance:g[L],btcPrice:P,previousBtcPrice:v[L-1],withdrawals:{btc:b[L],stocks:y[L],bonds:f[L]}}),d&&(console.log("Res",d),console.log(`Year ${L},  Total Balance: ${formatCurrency(V[L])}, Total withdrawal: ${formatCurrency(T)} 

        BTC Balance: ${formatCurrency(m[L])}, withdrawal: ${formatCurrency(b[L],2)}, price: ${formatCurrency(P)} 

        Stocks Balance: ${formatCurrency(x[L])}, withdrawal: ${formatCurrency(y[L])} 

        Bonds Balance: ${formatCurrency(h[L])}, withdrawal: ${formatCurrency(f[L])} 

        Cash Balance: ${formatCurrency(g[L])} 

        60/40 Portfolio: ${formatCurrency(w[L])} 

        Retirement Success: ${E[L]?"Yes":"No"} 

        `))}return{totalBalances:V,btcBalance:m,btcSold:b,stocksBalance:x,stocksSold:y,bondsBalance:h,bondsSold:f,cashIncomeBalance:g,btcPrices:v,retirementSuccessStatus:E,portfolio60_40:w}},m=$(inputValues["retirement-expenses"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!0,!1),b=$(inputValues["additional-other"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!1),x=$(inputValues["additional-bonds"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),y=$(inputValues["additional-stocks"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),h=$(inputValues["additional-btc"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),f=$(inputValues["retirement-income"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!0,!1);o(b,inputValues.expectancy);let g=p(m,inputValues["btc-account"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy),{totalBalances:v,btcBalance:E,btcSold:w,stocksBalance:C,stocksSold:Y,bondsBalance:S,bondsSold:A,cashIncomeBalance:k,btcPrices:B,retirementSuccessStatus:q,portfolio60_40:R}=V(g,f,h,y,x,b,inputValues.expectancy,currentYear+(inputValues["retirement-age"]-a),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"],!1),L={};if("roth"!==inputValues["btc-account"]){let P="roth"!==inputValues["btc-account"]&&p(m,"roth",currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy),{totalBalances:F,btcBalance:W,btcSold:D,stocksBalance:N,stocksSold:T,bondsBalance:M,bondsSold:I,cashIncomeBalance:z,btcPrices:O,retirementSuccessStatus:U,portfolio60_40:Z}=V(P,f,h,y,x,b,inputValues.expectancy,currentYear+(inputValues["retirement-age"]-a),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]);L=F}let G=i(m,currentYear+(inputValues["retirement-age"]-a)),H=n(v,currentYear+(inputValues["retirement-age"]-a)),K=r(v,currentYear-a+inputValues.expectancy),X=()=>{calcElementsAndRanges.forEach(e=>{let t=e.selector,n=e.min,i=e.max,l=e.step;if("retirement-age"===t){for(let u=n;u<=i;u+=l){let s=currentYear+(u-a),c=$(inputValues["retirement-expenses"],s,inputValues.expectancy,!0,!1),o=p(c,inputValues["btc-account"],s,inputValues.expectancy),d=$(inputValues["retirement-income"],s,inputValues.expectancy,!0,!1),m=$(inputValues["additional-btc"],s,inputValues.expectancy,!1,!0),b=$(inputValues["additional-stocks"],s,inputValues.expectancy,!1,!0),x=$(inputValues["additional-bonds"],s,inputValues.expectancy,!1,!0),y=$(inputValues["additional-other"],s,inputValues.expectancy,!1,!1),{totalBalances:h}=V(o,d,m,b,x,y,inputValues.expectancy,s,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),f=r(h,currentYear-a+inputValues.expectancy);if(f>0){optimalValues["retirement-age"]=u;break}u>=i&&(optimalValues["retirement-age"]=i)}optimalValues["retirement-age-reversed"]=!1}else if("expectancy"===t){for(let g=n;g<=i;g+=l){let v=currentYear-a+g,E=$(inputValues["retirement-expenses"],currentYear+(inputValues["retirement-age"]-a),g,!0,!1),w=p(E,inputValues["btc-account"],currentYear+(inputValues["retirement-age"]-a),g),C=$(inputValues["retirement-income"],currentYear+(inputValues["retirement-age"]-a),g,!0,!1),Y=$(inputValues["additional-btc"],currentYear+(inputValues["retirement-age"]-a),g,!1,!0),S=$(inputValues["additional-stocks"],currentYear+(inputValues["retirement-age"]-a),g,!1,!0),A=$(inputValues["additional-bonds"],currentYear+(inputValues["retirement-age"]-a),g,!1,!0),k=$(inputValues["additional-other"],currentYear+(inputValues["retirement-age"]-a),g,!1,!1),{totalBalances:B}=V(w,C,Y,S,A,k,g,currentYear+(inputValues["retirement-age"]-a),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),q=r(B,v);if(q<=0){optimalValues.expectancy=g-1;break}g>=i&&(optimalValues.expectancy=i)}optimalValues["expectancy-reversed"]=!0}else if("expected-stocks"===t){for(let R=n;R<=i;R+=l){let L=currentYear+(inputValues["retirement-age"]-a),P=$(inputValues["retirement-expenses"],L,inputValues.expectancy,!0,!1),F=p(P,inputValues["btc-account"],L,inputValues.expectancy),W=$(inputValues["retirement-income"],L,inputValues.expectancy,!0,!1),D=$(inputValues["additional-btc"],L,inputValues.expectancy,!1,!0),N=$(inputValues["additional-stocks"],L,inputValues.expectancy,!1,!0),T=$(inputValues["additional-bonds"],L,inputValues.expectancy,!1,!0),M=$(inputValues["additional-other"],L,inputValues.expectancy,!1,!1),{totalBalances:I}=V(F,W,D,N,T,M,inputValues.expectancy,L,R,inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),z=r(I,currentYear-a+inputValues.expectancy);if(z>0){optimalValues["expected-stocks"]=R;break}R>=i&&(optimalValues["expected-stocks"]=i)}optimalValues["expected-stocks-reversed"]=!1}else if("expected-bonds"===t){for(let O=n;O<=i;O+=l){let U=currentYear+(inputValues["retirement-age"]-a),Z=$(inputValues["retirement-expenses"],U,inputValues.expectancy,!0,!1),G=p(Z,inputValues["btc-account"],U,inputValues.expectancy),H=$(inputValues["retirement-income"],U,inputValues.expectancy,!0,!1),K=$(inputValues["additional-btc"],U,inputValues.expectancy,!1,!0),X=$(inputValues["additional-stocks"],U,inputValues.expectancy,!1,!0),j=$(inputValues["additional-bonds"],U,inputValues.expectancy,!1,!0),J=$(inputValues["additional-other"],U,inputValues.expectancy,!1,!1),{totalBalances:Q}=V(G,H,K,X,j,J,inputValues.expectancy,U,inputValues["expected-stocks"],O,inputValues["expected-cash"],inputValues["expected-btc"]),ee=r(Q,currentYear-a+inputValues.expectancy);if(ee>0){optimalValues["expected-bonds"]=O;break}O>=i&&(optimalValues["expected-bonds"]=i)}optimalValues["expected-bonds-reversed"]=!1}else if("expected-cash"===t){for(let et=n;et<=i;et+=l){let ea=currentYear+(inputValues["retirement-age"]-a),en=$(inputValues["retirement-expenses"],ea,inputValues.expectancy,!0,!1),er=p(en,inputValues["btc-account"],ea,inputValues.expectancy),ei=$(inputValues["retirement-income"],ea,inputValues.expectancy,!0,!1),el=$(inputValues["additional-btc"],ea,inputValues.expectancy,!1,!0),eu=$(inputValues["additional-stocks"],ea,inputValues.expectancy,!1,!0),es=$(inputValues["additional-bonds"],ea,inputValues.expectancy,!1,!0),e$=$(inputValues["additional-other"],ea,inputValues.expectancy,!1,!1),{totalBalances:ec}=V(er,ei,el,eu,es,e$,inputValues.expectancy,ea,inputValues["expected-stocks"],inputValues["expected-bonds"],et,inputValues["expected-btc"]),e0=r(ec,currentYear-a+inputValues.expectancy);if(e0>0){optimalValues["expected-cash"]=et;break}et>=i&&(optimalValues["expected-cash"]=i)}optimalValues["expected-cash-reversed"]=!1}else if("expected-btc"===t){for(let e_=n;e_<=i;e_+=l){let ep=currentYear+(inputValues["retirement-age"]-a),eo=$(inputValues["retirement-expenses"],ep,inputValues.expectancy,!0,!1),e2=p(eo,inputValues["btc-account"],ep,inputValues.expectancy),ed=$(inputValues["retirement-income"],ep,inputValues.expectancy,!0,!1),e4=$(inputValues["additional-btc"],ep,inputValues.expectancy,!1,!0),e3=$(inputValues["additional-stocks"],ep,inputValues.expectancy,!1,!0),e1=$(inputValues["additional-bonds"],ep,inputValues.expectancy,!1,!0),e7=$(inputValues["additional-other"],ep,inputValues.expectancy,!1,!1),{totalBalances:e6}=V(e2,ed,e4,e3,e1,e7,inputValues.expectancy,ep,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],e_),e5=r(e6,currentYear-a+inputValues.expectancy);if(e5>0){optimalValues["expected-btc"]=e_;break}e_>=i&&(optimalValues["expected-btc"]=i)}optimalValues["expected-btc-reversed"]=!1}else if("growth-rate"===t){for(let eV=n;eV<=i;eV+=l){let em=currentYear+(inputValues["retirement-age"]-a),eb=$(inputValues["retirement-expenses"],em,inputValues.expectancy,!0,!1,eV),ex=p(eb,inputValues["btc-account"],em,inputValues.expectancy),ey=$(inputValues["retirement-income"],em,inputValues.expectancy,!0,!1,eV),eh=$(inputValues["additional-btc"],em,inputValues.expectancy,!1,!0,eV),ef=$(inputValues["additional-stocks"],em,inputValues.expectancy,!1,!0,eV),eg=$(inputValues["additional-bonds"],em,inputValues.expectancy,!1,!0,eV),ev=$(inputValues["additional-other"],em,inputValues.expectancy,!1,!1,eV),{totalBalances:eE}=V(ex,ey,eh,ef,eg,ev,inputValues.expectancy,em,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),ew=r(eE,currentYear-a+inputValues.expectancy);if(ew>0){optimalValues["growth-rate"]=eV;break}eV>=i&&(optimalValues["growth-rate"]=i)}optimalValues["growth-rate-reversed"]=!1}else if("retirement-income"===t){for(let eC=n;eC<=i;eC+=2*l){let eY=currentYear+(inputValues["retirement-age"]-a),eS=$(inputValues["retirement-expenses"],eY,inputValues.expectancy,!0,!1),eA=p(eS,inputValues["btc-account"],eY,inputValues.expectancy),ek=$(eC,eY,inputValues.expectancy,!0,!1),eB=$(inputValues["additional-btc"],eY,inputValues.expectancy,!1,!0),e9=$(inputValues["additional-stocks"],eY,inputValues.expectancy,!1,!0),eq=$(inputValues["additional-bonds"],eY,inputValues.expectancy,!1,!0),eR=$(inputValues["additional-other"],eY,inputValues.expectancy,!1,!1),{totalBalances:e8}=V(eA,ek,eB,e9,eq,eR,inputValues.expectancy,eY,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),eL=r(e8,currentYear-a+inputValues.expectancy);if(eL>0){optimalValues["retirement-income"]=eC;break}}optimalValues["retirement-income-reversed"]=!1}else if("retirement-expenses"===t){for(let eP=n;eP<=i;eP+=2*l){let eF=currentYear+(inputValues["retirement-age"]-a),eW=$(eP,eF,inputValues.expectancy,!0,!1),eD=p(eW,inputValues["btc-account"],eF,inputValues.expectancy),eN=$(inputValues["retirement-income"],eF,inputValues.expectancy,!0,!1),eT=$(inputValues["additional-btc"],eF,inputValues.expectancy,!1,!0),eM=$(inputValues["additional-stocks"],eF,inputValues.expectancy,!1,!0),eI=$(inputValues["additional-bonds"],eF,inputValues.expectancy,!1,!0),ez=$(inputValues["additional-other"],eF,inputValues.expectancy,!1,!1),{totalBalances:eO}=V(eD,eN,eT,eM,eI,ez,inputValues.expectancy,eF,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),eU=r(eO,currentYear-a+inputValues.expectancy);if(eU<=0){optimalValues["retirement-expenses"]=eP-1;break}eP>=i&&(optimalValues["retirement-expenses"]=i)}optimalValues["retirement-expenses-reversed"]=!0}else if("capital-gains"===t){for(let eZ=n;eZ<=i;eZ+=l){let eG=currentYear+(inputValues["retirement-age"]-a),eH=$(inputValues["retirement-expenses"],eG,inputValues.expectancy,!0,!1),eK=p(eH,inputValues["btc-account"],eG,inputValues.expectancy,eZ),eX=$(inputValues["retirement-income"],eG,inputValues.expectancy,!0,!1),ej=$(inputValues["additional-btc"],eG,inputValues.expectancy,!1,!0),eJ=$(inputValues["additional-stocks"],eG,inputValues.expectancy,!1,!0),eQ=$(inputValues["additional-bonds"],eG,inputValues.expectancy,!1,!0),te=$(inputValues["additional-other"],eG,inputValues.expectancy,!1,!1),{totalBalances:tt}=V(eK,eX,ej,eJ,eQ,te,inputValues.expectancy,eG,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),ta=r(tt,currentYear-a+inputValues.expectancy);if(ta<=0){optimalValues["capital-gains"]=eZ-1;break}eZ>=i&&(optimalValues["capital-gains"]=i)}optimalValues["capital-gains-reversed"]=!0}else if("inflation-rate"===t){for(let tn=n;tn<=i;tn+=l){let tr=currentYear+(inputValues["retirement-age"]-a),ti=$(inputValues["retirement-expenses"],tr,inputValues.expectancy,!0,!1,inputValues["growth-rate"],tn),tl=p(ti,inputValues["btc-account"],tr,inputValues.expectancy),tu=$(inputValues["retirement-income"],tr,inputValues.expectancy,!0,!1,inputValues["growth-rate"],tn),ts=$(inputValues["additional-btc"],tr,inputValues.expectancy,!1,!0,inputValues["growth-rate"],tn),t$=$(inputValues["additional-stocks"],tr,inputValues.expectancy,!1,!0,inputValues["growth-rate"],tn),tc=$(inputValues["additional-bonds"],tr,inputValues.expectancy,!1,!0,inputValues["growth-rate"],tn),t0=$(inputValues["additional-other"],tr,inputValues.expectancy,!1,!1,inputValues["growth-rate"],tn),{totalBalances:t_}=V(tl,tu,ts,t$,tc,t0,inputValues.expectancy,tr,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),tp=r(t_,currentYear-a+inputValues.expectancy);if(tp<=0){optimalValues["inflation-rate"]=tn-1;break}tn>=i&&(optimalValues["inflation-rate"]=i)}optimalValues["inflation-rate-reversed"]=!0}}),updateAllRangesliders()},j=_.throttle(X,100,{trailing:!0});j(),d(a,E,B,G,q,K,H),updateMainChart(v,currentYear-a+inputValues.expectancy,a,R,L)};let chartInited=!1,chart,overviewChart,chartElements={};const updateMainChart=(e,t,a,n,r)=>{chartInited||(chartElements.resultsWrap=document.querySelector(".chart-wrap .chart-info"),chartElements.resultAge=document.querySelector("#chart-res-age"),chartElements.resultBtc=document.querySelector("#chart-res-btc"),chartElements.result60_40=document.querySelector("#chart-res-6040"),chartElements.resultRoth=document.querySelector("#chart-res-roth"),chartElements.rothWrap=document.querySelector(".chart-info #roth-wrap"),chartElements.resultDifference=document.querySelector("#chart-res-diff"));let i=[];for(let l=currentYear;l<=t;l++){let u=a+(l-currentYear);(l-currentYear)%10==0||l===t?i.push(u.toString()):i.push("")}let s=Object.fromEntries(Object.entries(e).filter(([e])=>Number(e)<=t)),$=Object.fromEntries(Object.entries(n).filter(([e])=>Number(e)<=t)),c={data:Object.values(s),borderColor:"#399E6A",fill:!1,borderWidth:2,tension:.4,pointRadius:0},p={data:Object.values($),borderColor:"#0095D6",backgroundColor:"#CDEFFF33",fill:!0,borderWidth:2,tension:.4,pointRadius:0},o={};if(Object.keys(r).length>0){let d=Object.fromEntries(Object.entries(r).filter(([e])=>Number(e)<=t));o={data:Object.values(d),borderColor:"#db9905",fill:!1,borderWidth:2,tension:.4,pointRadius:0},c.borderDash=[0,0]}else o={data:Object.values(s),borderColor:"#db9905",fill:!1,borderWidth:2,tension:.4,pointRadius:0},c.borderDash=[10,10];let V=document.querySelector(".calculator-chart").getContext("2d"),m=document.querySelector(".overview-chart").getContext("2d");Chart.defaults.font.family="Inter, sans-serif",Chart.defaults.font.size=12,Chart.defaults.font.weight=600;let b={id:"corsair",defaults:{width:1,color:"#CCEAF7",dash:[3,3]},afterInit(e,t,a){e.corsair={x:0,y:0}},afterEvent(e,t){let{inChartArea:a}=t,{type:n,x:r,y:i}=t.event;e.corsair={x:r,y:i,draw:a},e.draw()},beforeDatasetsDraw(e,t,a){let{ctx:n}=e,{top:r,bottom:i}=e.chartArea,{x:l,draw:u}=e.corsair;u&&(n.save(),n.beginPath(),n.lineWidth=a.width,n.strokeStyle=a.color,n.moveTo(l,i),n.lineTo(l,r),n.stroke(),n.restore())}},x={type:"line",data:{labels:i,datasets:[c,p]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!1,border:{display:!0,color:"#0A5999",width:2},grid:{display:!1,drawOnChartArea:!1,drawBorder:!1,drawTicks:!1,offset:!1},title:{display:!0,text:"AGE",color:"#0A5999",font:{size:16,weight:"bold"}},ticks:{color:"#0A5999",size:12,weight:"bold",family:"Inter",autoSkip:!1,padding:18,rotation:0,minRotation:0,maxRotation:0,align:"start",crossAlign:"far"}},y:{beginAtZero:!1,grid:{display:!0,color:"#CCEAF7",drawBorder:!1,drawTicks:!1,offset:!1},border:{display:!0,color:"#0A5999",width:2},ticks:{padding:0,color:"#0A5999",size:12,weight:"bold",family:"Inter",callback:e=>formatCurrencyShort(e),padding:8},title:{display:!1}}},layout:{padding:10}},plugins:[b]},y={type:"line",data:{labels:i,datasets:[c,p]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!1,border:{display:!0,color:"#0A5999",width:2},grid:{display:!1,drawOnChartArea:!1,drawBorder:!1,drawTicks:!1,offset:!1},title:{display:!0,text:"AGE",color:"#0A5999",padding:10,font:{size:8,weight:"bold"}},ticks:{display:!1}},y:{beginAtZero:!1,grid:{display:!0,color:"#CCEAF7",drawBorder:!1,drawTicks:!1,offset:!1},border:{display:!0,color:"#0A5999",width:2},ticks:{display:!1},title:{display:!1}}},layout:{padding:{top:0,right:0,bottom:0,left:1}}}};Object.keys(o).length>0&&(x.data.datasets.push(o),y.data.datasets.push(o)),chartInited?(chart.data.labels=i,chart.data.datasets=x.data.datasets,chart.options=x.options,chart.update("none"),overviewChart.data.labels=i,overviewChart.data.datasets=y.data.datasets,overviewChart.options=y.options,overviewChart.update("none")):(chart=new Chart(V,x),overviewChart=new Chart(m,y),V.canvas.addEventListener("mousemove",e=>{let t=chart.getElementsAtEventForMode(e,"index",{intersect:!1});if(t.length){let n=t[0],r=n.index,l=i[r]||a+r,u=chart.data.datasets[0].data[r],s=chart.data.datasets[1].data[r],$=chart.data.datasets[2]?.data[r]||0;chartElements.resultAge.textContent=l,chartElements.resultBtc.textContent=formatCurrency(u),chartElements.result60_40.textContent=formatCurrency(s),chartElements.resultRoth.textContent=formatCurrency($),chartElements.resultDifference.textContent=formatCurrency(u-s),chartElements.resultsWrap.classList.remove("is--inactive")}else chartElements.resultsWrap.classList.add("is--inactive")}),V.canvas.addEventListener("mouseleave",()=>{chartElements.resultsWrap.classList.add("is--inactive")}),chartInited=!0)};
