const chartHeight=32;let fixedBarCount=49;const optimalValues={};let displayGoldLine=!1,goldLineEqual=!1,annualCustomAsset1Savings={},annualCustomAsset2Savings={},annualCustomAsset3Savings={},annualCustomAsset4Savings={},annualCustomAsset5Savings={},customBtcAssets={};const calcSelectors=["retirement-age","expectancy","expected-stocks","expected-bonds","expected-btc","expected-cash","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate"],calcElementsAndRanges=[],inputValues={},onlyNumbers=e=>+String(e).replace(/\D/g,""),formatPercent=e=>`${e}%`,formatToFixed=(e,t=0)=>+e.toFixed(t),formatCurrencyShort=(e,t=0)=>e>=1e12?`$${(e/1e12).toFixed(1)}T`:e>=1e9?`$${(e/1e9).toFixed(1)}B`:e>=1e6?`$${(e/1e6).toFixed(t)}M`:e>=1e3?`$${(e/1e3).toFixed()}K`:`$${e}`,formatCurrency=(e,t=0)=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:t,maximumFractionDigits:t}).format(e),getBitcoinPrice=async()=>{try{const e=await fetch("https://blockchain.info/ticker"),t=(await e.json()).USD.last;currentBtcPrice=t,console.log(`Current Bitcoin Price in USD: $${t}`)}catch(e){console.error("Error fetching Bitcoin price:",e)}},getProjectedPortfolioAtRetirement=(e,t)=>e[t],getProjectedPortfolioAtDeath=(e,t)=>e[t],getAnnualBudgetAtRetirement=(e,t)=>e[t],getBitcoinPriceAtRetirement=(e,t)=>e[t],getBtcBalanceAtRetirement=(e,t)=>e[t],getBtcValueWithUsd=(e,t)=>e/t,updateRangeSliderScale=(e,t,a,n,s,r,c)=>{const i=(n-a)/(fixedBarCount-1),o=Math.round((s-a)/i);if(c===o)return"#E9EBF2";if(r){if(c<o){const e=.24+.6*((o-c)/o);return`rgba(57, 158, 106, ${Math.min(e,1)})`}{const e=.24+.6*((c-o)/(fixedBarCount-o));return`rgba(255, 91, 59, ${Math.min(e,1)})`}}if(c<o){const e=.24+.6*((o-c)/o);return`rgba(255, 91, 59, ${Math.min(e,1)})`}{const e=.24+.6*((c-o)/(fixedBarCount-o));return`rgba(57, 158, 106, ${Math.min(e,1)})`}},updateAllRangesliders=()=>{calcElementsAndRanges.forEach((e=>{const{selector:t,slider:a,min:n,max:s,step:r}=e,c=(a.value,optimalValues[t]),i=optimalValues[`${t}-reversed`];optimalValues[`${t}-bars`].attr("fill",((e,t)=>updateRangeSliderScale(0,0,n,s,c,i,t)))}))},updateHandle=(e,t)=>{const a=document.querySelector(`#${e} .calc__slider__scale__item.is--mid`),n=document.querySelector(`#${e} input[type="range"]`),s=(t-n.min)/(n.max-n.min),r=s*n.offsetWidth,c=100*s;"true"===a.getAttribute("is-percent")?a.innerText=formatPercent(t):"true"===a.getAttribute("is-usd")?a.innerText=formatCurrencyShort(t):a.innerText=onlyNumbers(t),c>97&&(a.nextElementSibling.style.opacity=0),c<3&&(a.previousElementSibling.style.opacity=0),c>3&&c<97&&(a.nextElementSibling.style.opacity=1,a.previousElementSibling.style.opacity=1),a.style.left=r+"px",a.style.transform=`translateX(-${c}%)`},initRangeSliders=()=>{calcSelectors.forEach((e=>{const t=document.querySelector(`#${e}`);if(!t)return void console.error(`Slider container not found for selector: ${e}`);const a=t.querySelector(".calc__graph");if(!a)return void console.error(`Graph container not found for selector: ${e}`);let n=a.clientWidth;const s=window.innerWidth<768?3:4,r=d3.select(a).append("svg").attr("width",n).attr("height",32),c=t.querySelector(".calc__slider-range");if(!c)return void console.error(`Slider not found for selector: ${e}`);c.min,c.max;const i=d3.range(fixedBarCount),o=(n-s*(fixedBarCount-1))/fixedBarCount,l=d3.scaleBand().domain(i).range([0,n]).paddingInner(s/(o+s)),u=r.selectAll("rect").data(i).enter().append("rect").attr("x",(e=>l(e))).attr("y",0).attr("width",o).attr("height",32);optimalValues[`${e}-bars`]=u;const d=()=>{const t=+c.value;updateAllRangesliders(),updateHandle(e,t)};let p;c.addEventListener("input",(()=>{clearTimeout(p),p=setTimeout((()=>{let a=c.value;const n=t.querySelector(`#${e}-i`);"retirement-age"===e&&a<inputValues["current-age"]&&(a=inputValues["current-age"],c.value=a),inputValues[e]=onlyNumbers(a),d(),n&&("true"===n.getAttribute("is-percent")?n.value=formatPercent(a):"true"===n.getAttribute("is-usd")?n.value=formatCurrency(a):n.value=onlyNumbers(a)),runCalculations()}),10)})),d();const m=()=>{n=a.clientWidth;const e=(n-s*(fixedBarCount-1))/fixedBarCount;l.range([0,n]),u.attr("x",(e=>l(e))).attr("width",e),d()};let y;window.addEventListener("resize",(()=>{clearTimeout(y),y=setTimeout(m,100)}));const g=t.querySelector(`#${e}-i`);g&&g.addEventListener("blur",(()=>{setTimeout((()=>{inputValues[e]=onlyNumbers(g.value),c.value=onlyNumbers(g.value),d()}),10)}))}))};window.addEventListener("load",(async()=>{await getBitcoinPrice();const e={},t=new URLSearchParams(window.location.search);for(const[a,n]of t)e[a]=n;window.innerWidth<768&&(fixedBarCount=35),calcSelectors.forEach((e=>{const t=document.querySelector(`#${e}`);if(!t)return void console.error(`Slider container not found for selector: ${e}`);const a=t.querySelector(".calc__graph");if(!a)return void console.error(`Graph container not found for selector: ${e}`);let n=a.clientWidth;const s=window.innerWidth<768?3:4,r=d3.select(a).append("svg").attr("width",n).attr("height",32),c=t.querySelector(".calc__slider-range");if(!c)return void console.error(`Slider not found for selector: ${e}`);c.min,c.max;const i=d3.range(fixedBarCount),o=(n-s*(fixedBarCount-1))/fixedBarCount,l=d3.scaleBand().domain(i).range([0,n]).paddingInner(s/(o+s)),u=r.selectAll("rect").data(i).enter().append("rect").attr("x",(e=>l(e))).attr("y",0).attr("width",o).attr("height",32);optimalValues[`${e}-bars`]=u;const d=()=>{const t=+c.value;updateAllRangesliders(),updateHandle(e,t)};let p;c.addEventListener("input",(()=>{clearTimeout(p),p=setTimeout((()=>{let a=c.value;const n=t.querySelector(`#${e}-i`);"retirement-age"===e&&a<inputValues["current-age"]&&(a=inputValues["current-age"],c.value=a),inputValues[e]=onlyNumbers(a),d(),n&&("true"===n.getAttribute("is-percent")?n.value=formatPercent(a):"true"===n.getAttribute("is-usd")?n.value=formatCurrency(a):n.value=onlyNumbers(a)),runCalculations()}),10)})),d();const m=()=>{n=a.clientWidth;const e=(n-s*(fixedBarCount-1))/fixedBarCount;l.range([0,n]),u.attr("x",(e=>l(e))).attr("width",e),d()};let y;window.addEventListener("resize",(()=>{clearTimeout(y),y=setTimeout(m,100)}));const g=t.querySelector(`#${e}-i`);g&&g.addEventListener("blur",(()=>{setTimeout((()=>{inputValues[e]=onlyNumbers(g.value),c.value=onlyNumbers(g.value),d()}),10)}))})),calcSelectors.forEach((t=>{const a=document.querySelector(`#${t} .calc__slider-range`);calcElementsAndRanges.push({selector:t,slider:a,element:a,min:+a.getAttribute("min"),max:+a.getAttribute("max"),step:+a.getAttribute("step")}),a&&(e[t]&&(a.value=e[t]),a.dispatchEvent(new Event("input")),runCalculations())}));const a=document.querySelectorAll('.calc-field[is-age="true"]'),n=document.querySelector("#retirement-age-i");a.forEach((e=>{const t=+e.getAttribute("max-age"),a=+e.getAttribute("min-age");e.addEventListener("input",(()=>{e.value=onlyNumbers(e.value)})),e.addEventListener("blur",(()=>{let s=onlyNumbers(e.value);s>t&&(s=t),s<a&&(s=a),"retirement-age-i"===e.id&&e.value<inputValues["current-age"]&&(s=inputValues["current-age"]),"current-age"===e.id&&e.value>inputValues["retirement-age"]&&(n.value=s,n.dispatchEvent(new Event("blur"))),e.value=s,inputValues[e.id]=s;const r=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");r?(r.value=s,r.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"max age: ",t,"min age:",a,"used value: ",s)}))}));document.querySelectorAll('.calc-field[is-percent="true"]').forEach((e=>{const t=+e.getAttribute("max-percent"),a=+e.getAttribute("min-percent");e.addEventListener("blur",(()=>{let n=onlyNumbers(e.value);n>t&&(n=t),n<a&&(n=a),e.value=formatPercent(n),inputValues[e.id]=n/100;const s=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");s?(s.value=n,s.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"only numbers: ",onlyNumbers(e.value),"used value: ",n/100)}))}));document.querySelectorAll('.calc-field[is-usd="true"]').forEach((e=>{const t=+e.getAttribute("max-usd"),a=+e.getAttribute("min-usd");e.addEventListener("blur",(()=>{let n=onlyNumbers(e.value);n>t&&(n=t),n<a&&(n=a),e.value=formatCurrency(n),inputValues[e.id]=n;const s=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");s?(s.value=n,s.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"only numbers: ",onlyNumbers(e.value),"used value: ",n)}))})),document.querySelectorAll(".calc-radio input").forEach((e=>{e.addEventListener("change",(()=>{inputValues[e.name]=e.value,runCalculations(),console.log(e.name,"radio value: ",e.value)}))})),document.querySelectorAll("input[init-value]").forEach((t=>{t.value=e[t.id]||t.getAttribute("init-value"),t.dispatchEvent(new Event("blur")),runCalculations()})),document.querySelectorAll('.calc-radio input[name="plan-type"]').forEach((e=>{e.addEventListener("change",(()=>{"custom"===document.querySelector('.calc-radio input[name="plan-type"]:checked').value?document.querySelector("#expected-btc").classList.remove("is--disabled"):document.querySelector("#expected-btc").classList.add("is--disabled")}))})),document.querySelectorAll("input[type='radio'][radio-initial='true']").forEach((t=>{const a=e[t.name];if(a===t.value)t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0}));else{const e=t.closest(".calc-layout__radios").querySelector(`input[value="${a}"]`);e?(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0}))):(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})))}runCalculations()})),document.querySelector("#share-btn").addEventListener("click",(function(){const e=this.textContent;this.textContent="Copied!",setTimeout((()=>this.textContent=e),2e3);const t=new URL(window.location.href),a=new URLSearchParams;["current-age","retirement-age","expectancy","balance-stocks","balance-bonds","balance-btc","additional-stocks","additional-bonds","additional-btc","expected-stocks","expected-bonds","expected-btc","plan-type","expected-cash","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate","custom-additional-1","custom-amount-1","custom-asset-1","custom-status-1","custom-additional-2","custom-amount-2","custom-asset-2","custom-status-2","custom-additional-3","custom-amount-3","custom-asset-3","custom-status-3","custom-additional-4","custom-amount-4","custom-asset-4","custom-status-4","custom-additional-5","custom-amount-5","custom-asset-5","custom-status-5"].forEach((e=>(inputValues[e]||0==inputValues[e])&&a.append(e,inputValues[e]))),t.search=a.toString(),navigator.clipboard.writeText(t.toString())})),document.querySelector("#reset-btn").addEventListener("click",(()=>{document.querySelectorAll("input[init-value]").forEach((e=>{e.value=e.getAttribute("init-value"),e.dispatchEvent(new Event("blur"))})),calcSelectors.forEach((e=>{const t=document.querySelector(`#${e} .calc__slider-range`);t&&(t.value=t.getAttribute("value"),t.dispatchEvent(new Event("input")))})),document.querySelectorAll("input[type='radio'][radio-initial='true']").forEach((e=>{e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0}))})),document.querySelectorAll(".calc-layout__custom__controls-icon.is--remove").forEach((e=>p(e))),document.querySelectorAll('.calc-layout__custom[custom-value-order="1"] .calc-dropdown').forEach(((e,t)=>{const a=e.querySelector(".calc-dropdown__toggle__text"),n=e.querySelector('.calc-dropdown__list__item[initial-value="true"]');a.textContent=n.textContent,0===t&&(inputValues["custom-asset-1"]=n.getAttribute("dropdown-value")),1===t&&(inputValues["custom-status-1"]=n.getAttribute("dropdown-value"))})),runCalculations()}));const s=document.querySelector(".secondary-popup"),r=document.querySelector(".secondary-popup .popup__close"),c=()=>{s.classList.remove("fade"),setTimeout((()=>s.classList.remove("show")),300)};let i=0,o=10,l=!1;document.addEventListener("click",(e=>{if(!l){if(e.target.closest(".calc-layout__sidebar__chart"))return o+=10;i++,i===o&&(s.classList.add("show"),setTimeout((()=>s.classList.add("fade")),10),l=!0)}})),r.addEventListener("click",c);let u=1;const d=()=>{const e=document.querySelector("#add-asset-btn"),t=document.querySelectorAll(".calc-layout__custom"),a=document.querySelector(".calc-layout__custom:not(.is--active)");if(!a)return;t.forEach((e=>e.classList.remove("is--last"))),a.classList.add("is--active");5===document.querySelectorAll(".calc-layout__custom.is--active").length&&e.classList.add("hidden"),a.style.order=u,u++},p=e=>{const t=document.querySelector("#add-asset-btn"),a=e.closest(".calc-layout__custom"),n=a.getAttribute("custom-value-order");a.querySelectorAll(".calc-dropdown__toggle__text").forEach((e=>e.textContent=e.getAttribute("initial-toggle-text"))),a.querySelectorAll("input.calc-field").forEach((e=>e.value="$"+e.getAttribute("init-value"))),inputValues[`custom-asset-${n}`]=0,inputValues[`custom-status-${n}`]=0,inputValues[`custom-amount-${n}`]=0,inputValues[`custom-additional-${n}`]=0,a.classList.remove("is--active","is--last"),document.querySelectorAll(".calc-layout__custom").forEach((e=>e.classList.remove("is--last")));const s=document.querySelectorAll(".calc-layout__custom.is--active");let r,c=-2;s.forEach((e=>{const t=+e.style.order;t>c&&(c=t,r=e)})),r.classList.add("is--last"),t.classList.remove("hidden"),runCalculations()};document.querySelectorAll(".calc-dropdown__list.is--initial").forEach((function(t){const a=t.closest(".calc-layout__custom").getAttribute("custom-value-order"),n=t.closest(".calc-dropdown").querySelector(".calc-dropdown__toggle__text"),s=t.getAttribute("custom-value-type");t.addEventListener("click",(function(e){if(!e.target.classList.contains("calc-dropdown__list__item"))return;n&&(n.textContent=e.target.textContent);const t=e.target.getAttribute("dropdown-value");inputValues[`custom-${s}-${a}`]=t,$(".calc-dropdown").trigger("w-close"),runCalculations()}));const r=e[`custom-${s}-${a}`]||!1;if("1"===a)r?(n&&(n.textContent=t.querySelector(`.calc-dropdown__list__item[dropdown-value="${r}"]`).textContent),inputValues[`custom-${s}-1`]=r):(n&&(n.textContent=t.querySelector('.calc-dropdown__list__item[initial-value="true"]').textContent),inputValues[`custom-${s}-1`]=t.querySelector('.calc-dropdown__list__item[initial-value="true"]').getAttribute("dropdown-value"));else if(a&&r&&"0"!==r){`custom-asset-${a}`==`custom-${s}-${a}`&&!1!==`custom-${s}-${a}`&&d();const e=t.querySelector(`.calc-dropdown__list__item[dropdown-value="${r}"]`);e&&n&&(n.textContent=e.textContent,inputValues[`custom-${s}-${a}`]=r)}t.classList.remove("is--initial")})),document.querySelector("#add-asset-btn")?.addEventListener("click",d),document.querySelectorAll(".calc-layout__custom__controls-icon.is--remove").forEach((e=>{e.addEventListener("click",(function(){p(e)}))}));if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){let e=null;document.querySelectorAll(".calc__slider-range").forEach((t=>{t.addEventListener("mousedown",(()=>{e=t})),t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation()})),t.addEventListener("pointerdown",(e=>{e.preventDefault(),e.stopPropagation()}))})),r.addEventListener("touchend",c),r.addEventListener("touchend",c),r.addEventListener("pointerdown",c),document.addEventListener("mousemove",(t=>{e?.contains(t.target)||t.preventDefault()})),document.addEventListener("mouseup",(()=>e=null))}const m=document.querySelector(".calc-layout__right"),y=document.querySelector(".container.is--simple-nav"),g=()=>{if(m&&y){const e=y.offsetHeight;window.addEventListener("scroll",(function(){window.innerWidth<992&&window.scrollY>e?m.classList.add("is--fixed"):m.classList.remove("is--fixed")}))}else console.error("Required elements are missing in the DOM.")};window.innerWidth<992&&g(),window.addEventListener("resize",(()=>{window.innerWidth>=992?m&&m.classList.remove("is--fixed"):g()})),window.dispatchEvent(new Event("resize"))}));const currentYear=(new Date).getFullYear();let currentBtcPrice=65e3;const btcPricesS2F=()=>{const e=52560,t=3.9954337899543377;let a=[{year:2010,price:.06,sf:1.5},{year:2011,price:6,sf:2.5},{year:2012,price:12,sf:4.5},{year:2013,price:742,sf:10.5},{year:2014,price:318,sf:12.5},{year:2015,price:431,sf:15.5},{year:2016,price:967,sf:21.5},{year:2017,price:13900,sf:25.5},{year:2018,price:3688,sf:27.5},{year:2019,price:7185,sf:28.5},{year:2020,price:28997,sf:56},{year:2021,price:46155,sf:56.2},{year:2022,price:16663,sf:56.4},{year:2023,price:42297,sf:56.6},{year:2024,price:99968,sf:119.7}];if(currentBtcPrice){const e=a.findIndex((e=>e.year===currentYear));if(-1!==e)a[e].price=currentBtcPrice;else{const e=a[a.length-1];a.push({year:currentYear,price:currentBtcPrice,sf:e.sf})}}const n=a.map((({sf:e,price:t})=>({x:Math.log10(e),y:Math.log10(t)}))),s=n.length,r=n.reduce(((e,t)=>e+t.x),0),c=n.reduce(((e,t)=>e+t.y),0),i=(s*n.reduce(((e,t)=>e+t.x*t.y),0)-r*c)/(s*n.reduce(((e,t)=>e+t.x*t.x),0)-r*r),o=(c-i*r)/s,l=a=>{const n=Math.floor(a/t),s=50/Math.pow(2,n)*e;return u(a)/s},u=a=>{let n=0,s=50;for(let r=0;r<a;r++){const a=Math.floor(r/t);s=50/Math.pow(2,a),n+=s*e}return n},d={};for(let e=0;e<150;e++){const t=2010+e;if(t===currentYear&&currentBtcPrice)d[t]=currentBtcPrice;else{const a=l(e),n=i*Math.log10(a)+o;d[t]=Math.pow(10,n)}}return d},btcPricesPowerLaw=()=>{const e=[{time:1,price:.03},{time:2,price:1.17},{time:3,price:9.91},{time:4,price:45.2},{time:5,price:146.7},{time:6,price:383.87},{time:7,price:865.75},{time:8,price:1751.3},{time:9,price:3260.17},{time:10,price:5684.04},{time:11,price:9398.21},{time:12,price:14873.64},{time:13,price:22689.36},{time:14,price:33545.07},{time:15,price:currentBtcPrice||99636.1}].map((({time:e,price:t})=>({x:Math.log(e),y:Math.log(t)}))),t=e.length,a=e.reduce(((e,t)=>e+t.x),0),n=e.reduce(((e,t)=>e+t.y),0),s=(t*e.reduce(((e,t)=>e+t.x*t.y),0)-a*n)/(t*e.reduce(((e,t)=>e+t.x*t.x),0)-a*a),r=Math.exp((n-s*a)/t),c=currentYear-2010+1,i=r*Math.pow(c,s),o=currentBtcPrice/i,l={};for(let e=0;e<150;e++){const t=2010+e,a=r*Math.pow(e+1,s),n=Math.abs(t-currentYear),c=1+(o-1)*Math.exp(-n/10);l[t]=a*c}return l},btcPricesBtc24=()=>{const e=currentYear,t={[e]:currentBtcPrice};for(let a=1;a<=150;a++){const n=Math.max(50-2.5*(a-1),20),s=t[e+(a-1)];t[e+a]=s*(1+n/100)}return t},btcPricesCustom=e=>{const t={[currentYear]:currentBtcPrice};for(let a=1;a<=150;a++){const n=t[currentYear+a-1];t[currentYear+a]=n*(1+e/100)}return t},sidebarElements={};document.addEventListener("DOMContentLoaded",(()=>{sidebarElements.retireBy=document.querySelector("#res-retire-by"),sidebarElements.portfolioAtRetirement=document.querySelector("#res-portfolio-retirement"),sidebarElements.btcAtRetirement=document.querySelector("#res-btc-retirement"),sidebarElements.btcPriceAtRetirement=document.querySelector("#res-btc-price-retirement"),sidebarElements.monthlyBudget=document.querySelector("#res-budget-monthly"),sidebarElements.annualBudget=document.querySelector("#res-budget-year"),sidebarElements.yearsOfWithdrawals=document.querySelector("#res-years-of-withdrawals"),sidebarElements.portfolioAtDeath=document.querySelector("#res-portfolio-at-death"),sidebarElements.successMessage=document.querySelector('.notification[notification="success"]'),sidebarElements.errorMessage=document.querySelector('.notification[notification="fail"]'),sidebarElements.mobileUnderline=document.querySelector(".calc-mobile__underline")}));const runCalculations=()=>{if(["current-age","balance-stocks","balance-bonds","balance-btc","additional-stocks","additional-bonds","additional-btc","retirement-age","expectancy","expected-stocks","expected-bonds","expected-cash","expected-btc","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate","plan-type"].filter((e=>!inputValues[e]&&0!==inputValues[e])).length>0)return;const e=inputValues["current-age"],t=(e,t,a,n=!1,s=!0,r=inputValues["growth-rate"],c=inputValues["inflation-rate"])=>{const i={};i[currentYear]=e;for(let e=1;e<=a;e++){const a=i[currentYear+(e-1)],o=currentYear+e;if(s&&o>t)continue;const l=a*(1+(n?c:r)/100);i[o]=l}return i},a=()=>{let a=0;for(i=1;i<=5;i++)a+=+inputValues[`custom-additional-${i}`]||0;return t(a,currentYear+inputValues["retirement-age"]-e,inputValues.expectancy,!1,!0)},n=(e,t)=>{switch(e){case"stocks":return 1+inputValues["expected-stocks"]/100;case"bonds":return 1+inputValues["expected-bonds"]/100;case"btc":return t;case"other":return 1+inputValues["expected-cash"]/100;default:return 1}},s=(e,t,a,n=inputValues["capital-gains"])=>{const s={};for(let r=1;r<=a;r++){const a=currentYear+r;s[a]=a>t?e[a]/(1-n/100):0}return s},r=(t,a,s,r,c,i,o,l,u,d,p,m,y=!1,g=!1)=>{const b={},h={},V={},f={},x={},v={},S={},E=(w=m,inputValues["balance-btc"],"btc24"===inputValues["plan-type"]?btcPricesBtc24():"power-law"===inputValues["plan-type"]?btcPricesPowerLaw():"custom"===inputValues["plan-type"]?btcPricesCustom(w):btcPricesS2F());var w;const _={},A={},L={},C={},q=u,B=d,P=inputValues["balance-stocks"],k=inputValues["balance-bonds"],Y=inputValues["balance-btc"];let $=!1;const M=inputValues["custom-amount-1"]||0,R=inputValues["custom-amount-2"]||0,D=inputValues["custom-amount-3"]||0,T=inputValues["custom-amount-4"]||0,W=inputValues["custom-amount-5"]||0;let j=inputValues["custom-asset-1"],N=inputValues["custom-asset-2"],F=inputValues["custom-asset-3"],I=inputValues["custom-asset-4"],O=inputValues["custom-asset-5"],U=inputValues["custom-status-1"],G=inputValues["custom-status-2"],z=inputValues["custom-status-3"],H=inputValues["custom-status-4"],Z=inputValues["custom-status-5"];const K={},X={},J={},Q={},ee={},te={},ae={},ne={},se={},re={};if(g&&(U="traditional"===U&&"btc"===j||"none"!==U&&"btc"!==j?"roth":inputValues["custom-status-1"],G="traditional"===G&&"btc"===N||"none"!==G&&"btc"!==N?"roth":inputValues["custom-status-2"],z="traditional"===z&&"btc"===F||"none"!==z&&"btc"!==F?"roth":inputValues["custom-status-3"],H="traditional"===H&&"btc"===I||"none"!==H&&"btc"!==I?"roth":inputValues["custom-status-4"],Z="traditional"===Z&&"btc"===O||"none"!==Z&&"btc"!==O?"roth":inputValues["custom-status-5"],j="roth"===U?"btc":inputValues["custom-asset-1"],N="roth"===G?"btc":inputValues["custom-asset-2"],F="roth"===z?"btc":inputValues["custom-asset-3"],I="roth"===H?"btc":inputValues["custom-asset-4"],O="roth"===Z?"btc":inputValues["custom-asset-5"]),!g){let e=("traditional"===U&&"btc"===j||"none"!==U&&"btc"!==j?0===M?1:M:0)+("traditional"===G&&"btc"===N||"none"!==G&&"btc"!==N?0===R?1:R:0)+("traditional"===z&&"btc"===F||"none"!==z&&"btc"!==F?0===D?1:D:0)+("traditional"===H&&"btc"===I||"none"!==H&&"btc"!==I?0===T?1:T:0)+("traditional"===Z&&"btc"===O||"none"!==Z&&"btc"!==O?0===W?1:W:0);M+R+D+T+W>0&&("roth"===U&&"btc"===j?M:0)+("roth"===G&&"btc"===N?R:0)+("roth"===z&&"btc"===F?D:0)+("roth"===H&&"btc"===I?T:0)+("roth"===Z&&"btc"===O?W:0)===e?goldLineEqual=displayGoldLine=!0:e>0?(goldLineEqual=!1,displayGoldLine=!0):(goldLineEqual=!1,displayGoldLine=!1)}b[currentYear]=k+P+Y+M+R+D+T+W,h[currentYear]=Y,f[currentYear]=P,v[currentYear]=k,K[currentYear]=M,X[currentYear]=R,J[currentYear]=D,Q[currentYear]=T,ee[currentYear]=W,g||(customBtcAssets={},customBtcAssets[currentYear]=("btc"===j?M:0)+("btc"===N?R:0)+("btc"===F?D:0)+("btc"===I?T:0)+("btc"===O?W:0)),A[currentYear]=b[currentYear],L[currentYear]=.6*b[currentYear],C[currentYear]=.4*b[currentYear];for(let i=1;i<=o;i++){const o=currentYear+i,u=e+i,d=E[o],p=b[o-1]||0;y&&inputValues.expectancy;let m=0,w=0,P=0,k=0,Y=0,M=0,R=0,D=0;const T=Math.max(t[o]-a[o-1]||0,0);Math.max(a[o-1]-t[o],0);if(o>l&&p>0&&0!==T){const e=h[o-1]||0,t=f[o-1]||0,a=v[o-1]||0,n=K[o-1]||0,s=X[o-1]||0,r=J[o-1]||0,c=Q[o-1]||0,i=ee[o-1]||0,l=Math.max(p-("roth"===U?n:0)-("roth"===G?s:0)-("roth"===z?r:0)-("roth"===H?c:0)-("roth"===Z?i:0),0);Math.max(p-l,0);if(u>=60||u<60&&l>=T){$=!1;let l=T;const d=[{balance:e||0,proportion:0,sold:0},{balance:t||0,proportion:0,sold:0},{balance:a||0,proportion:0,sold:0},{balance:n||0,proportion:0,sold:0,include:"roth"!==U||u>=60},{balance:s||0,proportion:0,sold:0,include:"roth"!==G||u>=60},{balance:r||0,proportion:0,sold:0,include:"roth"!==z||u>=60},{balance:c||0,proportion:0,sold:0,include:"roth"!==H||u>=60},{balance:i||0,proportion:0,sold:0,include:"roth"!==Z||u>=60}].filter((e=>e.balance>0&&!1!==e.include)),p=d.reduce(((e,t)=>e+t.balance),0);if(p>0){d.forEach((e=>{e.proportion=e.balance/p})),d.forEach((e=>{const t=l*e.proportion;e.sold=Math.min(t,e.balance)}));const e=d.reduce(((e,t)=>e+t.sold),0);if(e<l){const t=l-e,a=d.filter((e=>e.sold<e.balance));if(a.length>0){const e=a.reduce(((e,t)=>e+(t.balance-t.sold)),0);a.forEach((a=>{const n=(a.balance-a.sold)/e,s=Math.min(t*n,a.balance-a.sold);a.sold+=s}))}}}m=d.find((t=>t.balance===e))?.sold||0,w=d.find((e=>e.balance===t))?.sold||0,P=d.find((e=>e.balance===a))?.sold||0,k=d.find((e=>e.balance===n))?.sold||0,Y=d.find((e=>e.balance===s))?.sold||0,M=d.find((e=>e.balance===r))?.sold||0,R=d.find((e=>e.balance===c))?.sold||0,D=d.find((e=>e.balance===i))?.sold||0,T>0&&(m=Math.min(m,e),w=Math.min(w,t),P=Math.min(P,a),k=Math.min(k,K[o-1]),Y=Math.min(Y,X[o-1]),M=Math.min(M,J[o-1]),R=Math.min(R,Q[o-1]),D=Math.min(D,ee[o-1]))}else{$=!0;const l=[{name:"btc",balance:e||0,isRoth:!1},{name:"stocks",balance:t||0,isRoth:!1},{name:"bonds",balance:a||0,isRoth:!1},{name:"custom1",balance:n||0,isRoth:"roth"===U},{name:"custom2",balance:s||0,isRoth:"roth"===G},{name:"custom3",balance:r||0,isRoth:"roth"===z},{name:"custom4",balance:c||0,isRoth:"roth"===H},{name:"custom5",balance:i||0,isRoth:"roth"===Z}].filter((e=>e.balance>0));let u=T;l.forEach((e=>e.sold=0));const d=l.filter((e=>!e.isRoth)),p=d.reduce(((e,t)=>e+t.balance),0);if(p>0){const e=Math.min(u,p);d.forEach((t=>{const a=t.balance/p;t.sold=Math.min(e*a,t.balance)})),u-=d.reduce(((e,t)=>e+t.sold),0)}if(u>0){const e=1.3*u,t=l.filter((e=>e.isRoth)),a=t.reduce(((e,t)=>e+t.balance),0);if(a>0){const n=Math.min(e,a);t.forEach((e=>{const t=e.balance/a;e.sold=Math.min(n*t,e.balance)}))}}m=l.find((e=>"btc"===e.name))?.sold||0,w=l.find((e=>"stocks"===e.name))?.sold||0,P=l.find((e=>"bonds"===e.name))?.sold||0,k=l.find((e=>"custom1"===e.name))?.sold||0,Y=l.find((e=>"custom2"===e.name))?.sold||0,M=l.find((e=>"custom3"===e.name))?.sold||0,R=l.find((e=>"custom4"===e.name))?.sold||0,D=l.find((e=>"custom5"===e.name))?.sold||0,T>0&&(m=Math.min(m,e),w=Math.min(w,t),P=Math.min(P,a),k=Math.min(k,K[o-1]),Y=Math.min(Y,X[o-1]),M=Math.min(M,J[o-1]),R=Math.min(R,Q[o-1]),D=Math.min(D,ee[o-1]))}}if(p>0){V[o]=-m,x[o]=-w,S[o]=-P,te[o]=-k,ae[o]=-Y,ne[o]=-M,se[o]=-R,re[o]=-D;const e=d/E[o-1];h[o]=(h[o-1]||0)*e+(s[o]||0)+V[o],f[o]=(f[o-1]||0)*(1+q/100)+(r[o]||0)+x[o],v[o]=(v[o-1]||0)*(1+B/100)+(c[o]||0)+S[o],K[o]=(K[o-1]||0)*n(j,e)+(annualCustomAsset1Savings[o]||0)+te[o],X[o]=(X[o-1]||0)*n(N,e)+(annualCustomAsset2Savings[o]||0)+ae[o],J[o]=(J[o-1]||0)*n(F,e)+(annualCustomAsset3Savings[o]||0)+ne[o],Q[o]=(Q[o-1]||0)*n(I,e)+(annualCustomAsset4Savings[o]||0)+se[o],ee[o]=(ee[o-1]||0)*n(O,e)+(annualCustomAsset5Savings[o]||0)+re[o],g||(customBtcAssets[o]=("btc"===j?K[o]:0)+("btc"===N?X[o]:0)+("btc"===F?J[o]:0)+("btc"===I?Q[o]:0)+("btc"===O?ee[o]:0)),b[o]=p>T?Math.max(h[o]+f[o]+v[o]+K[o]+X[o]+J[o]+Q[o]+ee[o]):0}else h[o]=0,f[o]=0,v[o]=0,b[o]=0,K[o]=0,X[o]=0,J[o]=0,Q[o]=0,ee[o]=0;_[o]=p>T;const W=L[o-1],ce=C[o-1],ie=W+ce,oe=T*(W/ie),le=T*(ce/ie);o>l?A[o-1]>0&&T<ie?(L[o]=W*(1+q/100)-oe,C[o]=ce*(1+B/100)-le,A[o]=Math.max(L[o]+C[o],0)):A[o]=0:(L[o]=W*(1+q/100),C[o]=ce*(1+B/100),A[o]=Math.max(L[o]+C[o],0)),isNaN(b[o])&&console.error("NaN detected in year:",o,{btcBalance:h[o],stocksBalance:f[o],bondsBalance:v[o],totalBalance:b[o],btcPrice:d,previousBtcPrice:E[o-1],previousTotalBalance:p,netWithdrawal:T,withdrawals:{btc:V[o],stocks:x[o],bonds:S[o],custom1:te[o],custom2:ae[o],custom3:ne[o],custom4:se[o],custom5:re[o]}})}return{totalBalances:b,btcBalance:h,btcSold:V,stocksBalance:f,stocksSold:x,bondsBalance:v,bondsSold:S,btcPrices:E,retirementSuccessStatus:_,portfolio60_40:A}},c=t(inputValues["retirement-expenses"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!0,!1),o=(t(inputValues["additional-cash"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!1),t(inputValues["additional-bonds"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0)),l=t(inputValues["additional-stocks"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0);a();annualCustomAsset1Savings={},annualCustomAsset1Savings=t(inputValues["custom-additional-1"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0),annualCustomAsset2Savings={},annualCustomAsset2Savings=t(inputValues["custom-additional-2"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0),annualCustomAsset3Savings={},annualCustomAsset3Savings=t(inputValues["custom-additional-3"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0),annualCustomAsset4Savings={},annualCustomAsset4Savings=t(inputValues["custom-additional-4"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0),annualCustomAsset5Savings={},annualCustomAsset5Savings=t(inputValues["custom-additional-5"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0);const u=t(inputValues["additional-btc"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!1,!0),d=t(inputValues["retirement-income"],currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy,!0,!1),p=s(c,currentYear+(inputValues["retirement-age"]-e),inputValues.expectancy),{totalBalances:m,btcBalance:y,btcSold:g,stocksBalance:b,stocksSold:h,bondsBalance:V,bondsSold:f,btcPrices:x,retirementSuccessStatus:v,portfolio60_40:S}=r(p,d,u,l,o,0,inputValues.expectancy,currentYear+(inputValues["retirement-age"]-e),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"],!0,!1);let E={};const{totalBalances:w,btcBalance:A,btcSold:L,stocksBalance:C,stocksSold:q,bondsBalance:B,bondsSold:P,cashIncomeBalance:k,btcPrices:Y,retirementSuccessStatus:$,portfolio60_40:M}=r(p,d,u,l,o,0,inputValues.expectancy,currentYear+(inputValues["retirement-age"]-e),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"],!1,!0);E=w;const R=(D=c,T=currentYear+(inputValues["retirement-age"]-e),D[T]);var D,T;const W=getProjectedPortfolioAtRetirement(m,currentYear+(inputValues["retirement-age"]-e)),j=getProjectedPortfolioAtDeath(m,currentYear-e+inputValues.expectancy);_.throttle((()=>{calcElementsAndRanges.forEach((n=>{const c=n.selector,i=n.min,o=n.max,l=n.step;if("retirement-age"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(d-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["retirement-age-reversed"]=!1}else if("expectancy"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear-e+d,p=t(inputValues["retirement-expenses"],currentYear+(inputValues["retirement-age"]-e),d,!0,!1),m=s(p,currentYear+(inputValues["retirement-age"]-e),d),y=t(inputValues["retirement-income"],currentYear+(inputValues["retirement-age"]-e),d,!0,!1),g=t(inputValues["additional-btc"],currentYear+(inputValues["retirement-age"]-e),d,!1,!0),b=t(inputValues["additional-stocks"],currentYear+(inputValues["retirement-age"]-e),d,!1,!0),h=t(inputValues["additional-bonds"],currentYear+(inputValues["retirement-age"]-e),d,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,d,currentYear+(inputValues["retirement-age"]-e),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,l)<=0){optimalValues[c]=d-1,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&u.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.add("is--gray"),u.classList.remove("is--gray"))}optimalValues["expectancy-reversed"]=!0}else if("expected-stocks"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,d,inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["expected-stocks-reversed"]=!1}else if("expected-bonds"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],d,inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["expected-bonds-reversed"]=!1}else if("expected-cash"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],0,inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["expected-cash-reversed"]=!1}else if("expected-btc"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],d));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["expected-btc-reversed"]=!1}else if("growth-rate"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1,d),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1,d),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0,d),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0,d),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0,d),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["growth-rate-reversed"]=!1}else if("retirement-income"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=2*l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(d,l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)>0){optimalValues[c]=d,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&n.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["retirement-income-reversed"]=!1}else if("retirement-expenses"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=2*l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(d,l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)<=0){optimalValues[c]=d-1,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&u.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.add("is--gray"),u.classList.remove("is--gray"))}optimalValues["retirement-expenses-reversed"]=!0}else if("capital-gains"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1),m=s(p,l,inputValues.expectancy,d),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)<=0){optimalValues[c]=d-1,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&u.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.add("is--gray"),u.classList.remove("is--gray"))}optimalValues["capital-gains-reversed"]=!0}else if("inflation-rate"===c){const n=document.querySelector(`#${c} .calc-range__info-text.is--red`),u=document.querySelector(`#${c} .calc-range__info-text.is--green`);for(let d=i;d<=o;d+=l){const l=currentYear+(inputValues["retirement-age"]-e),p=t(inputValues["retirement-expenses"],l,inputValues.expectancy,!0,!1,inputValues["growth-rate"],d),m=s(p,l,inputValues.expectancy),y=t(inputValues["retirement-income"],l,inputValues.expectancy,!0,!1,inputValues["growth-rate"],d),g=t(inputValues["additional-btc"],l,inputValues.expectancy,!1,!0,inputValues["growth-rate"],d),b=t(inputValues["additional-stocks"],l,inputValues.expectancy,!1,!0,inputValues["growth-rate"],d),h=t(inputValues["additional-bonds"],l,inputValues.expectancy,!1,!0,inputValues["growth-rate"],d),{totalBalances:V}=(a(),r(m,y,g,b,h,0,inputValues.expectancy,l,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]));if(getProjectedPortfolioAtDeath(V,currentYear-e+inputValues.expectancy)<=0){optimalValues[c]=d-1,u.classList.remove("is--gray"),n.classList.remove("is--gray"),d===i&&u.classList.add("is--gray");break}d>=o&&(optimalValues[c]=o,n.classList.add("is--gray"),u.classList.remove("is--gray"))}optimalValues["inflation-rate-reversed"]=!0}})),updateAllRangesliders()}),100,{trailing:!0})(),((e,t,a,n,s,r,c)=>{setTimeout((()=>{const i=currentYear+(inputValues["retirement-age"]-e),o=getBitcoinPriceAtRetirement(a,i),l=getBtcValueWithUsd(customBtcAssets[i]||0,o),u=getBtcBalanceAtRetirement(t,i)/o;console.log("customBtcBalanceAtRetirement",l,"btcBalanceAtRetirement",u),sidebarElements.retireBy&&(sidebarElements.retireBy.value=inputValues["retirement-age"]),sidebarElements.portfolioAtRetirement&&(sidebarElements.portfolioAtRetirement.value=formatCurrency(c)),sidebarElements.btcAtRetirement&&(sidebarElements.btcAtRetirement.value="â‚¿"+formatCurrency(u+l,3).replace("$","")),sidebarElements.btcPriceAtRetirement&&(sidebarElements.btcPriceAtRetirement.value=formatCurrency(o)),sidebarElements.monthlyBudget&&(sidebarElements.monthlyBudget.value=formatCurrency(n/12)),sidebarElements.annualBudget&&(sidebarElements.annualBudget.value=formatCurrency(n)),sidebarElements.yearsOfWithdrawals&&(sidebarElements.yearsOfWithdrawals.value=formatToFixed(((e,t,a)=>{let n=0;for(let s=t;s<=a&&e[s];s++)n++;return n})(s,i,currentYear-e+inputValues.expectancy),1)),sidebarElements.portfolioAtDeath&&(sidebarElements.portfolioAtDeath.value=formatCurrency(r)),r<=0?(sidebarElements.successMessage.classList.add("hidden"),sidebarElements.errorMessage.classList.remove("hidden"),sidebarElements.mobileUnderline.classList.remove("is--green")):(sidebarElements.successMessage.classList.remove("hidden"),sidebarElements.errorMessage.classList.add("hidden"),sidebarElements.mobileUnderline.classList.add("is--green"))}),50)})(e,y,x,R,v,j,W),updateMainChart(m,currentYear-e+inputValues.expectancy,e,S,E)};let chart,overviewChart,chartInited=!1,chartElements={};const updateMainChart=(e,t,a,n,s)=>{const r=window.innerWidth<991;chartInited||(chartElements.chartWrap=document.querySelector(".popup__chart-content.is--main .chart-wrap"),chartElements.resultsWrap=document.querySelector(".chart-wrap .chart-info"),chartElements.resultAge=document.querySelector("#chart-res-age"),chartElements.resultBtc=document.querySelector("#chart-res-btc"),chartElements.result60_40=document.querySelector("#chart-res-6040"),chartElements.resultRoth=document.querySelector("#chart-res-roth"),chartElements.rothWrap=document.querySelector(".chart-info #roth-wrap"),chartElements.resultDifference=document.querySelector("#chart-res-diff"));const c=[];for(let e=currentYear;e<=t;e++){const n=a+(e-currentYear);(e-currentYear)%10==0||e===t?c.push(n.toString()):c.push("")}const i=Object.fromEntries(Object.entries(e).filter((([e])=>Number(e)<=t))),o=Object.fromEntries(Object.entries(n).filter((([e])=>Number(e)<=t))),l={data:Object.values(i),borderColor:"#399E6A",fill:!1,borderWidth:2,tension:.4,pointRadius:0},u={data:Object.values(o),borderColor:"#0095D6",backgroundColor:"#CDEFFF33",fill:!0,borderWidth:2,tension:.4,pointRadius:0};let d={};if(displayGoldLine){const e=Object.fromEntries(Object.entries(s).filter((([e])=>Number(e)<=t)));d={data:Object.values(e),borderColor:"#db9905",fill:!1,borderWidth:2,tension:.4,pointRadius:0},chartElements.rothWrap.classList.remove("hidden")}else chartElements.rothWrap.classList.add("hidden");l.borderDash=goldLineEqual?[10,10]:[0,0];const p=document.querySelector(".calculator-chart").getContext("2d"),m=document.querySelector(".overview-chart").getContext("2d");Chart.defaults.font.family="Inter, sans-serif",Chart.defaults.font.size=12,Chart.defaults.font.weight=600;const y={id:"corsair",defaults:{width:2,color:"#CCEAF7",dash:[0,0]},afterInit:(e,t,a)=>{e.corsair={x:0,y:0}},afterEvent:(e,t)=>{const{inChartArea:a}=t,{x:n,y:s}=t.event,r=e.getElementsAtEventForMode(t.event,"index",{intersect:!1});if(r.length>0){const t=e.getDatasetMeta(0).data[r[0].index];e.corsair={x:t.x,y:s,draw:a};const n=r[0].index,c=inputValues["current-age"]+n,i=e.data.datasets[0].data[n],o=e.data.datasets[1].data[n],l=e.data.datasets[2]?.data[n]||0;chartElements.resultAge.textContent=c,chartElements.resultBtc.textContent=formatCurrency(i),chartElements.result60_40.textContent=formatCurrency(o),chartElements.resultRoth.textContent=formatCurrency(l),chartElements.resultDifference.textContent=formatCurrency(i-o),chartElements.resultsWrap.classList.remove("is--inactive")}else e.corsair={x:n,y:s,draw:!1},chartElements.resultsWrap.classList.add("is--inactive");e.draw()},beforeDatasetsDraw:(e,t,a)=>{const{ctx:n}=e,{top:s,bottom:r}=e.chartArea,{x:c,draw:i}=e.corsair;i&&(n.save(),n.beginPath(),n.lineWidth=a.width,n.strokeStyle=a.color,n.setLineDash(a.dash),n.moveTo(c,r),n.lineTo(c,s),n.stroke(),n.restore())}},g={id:"dotPlugin",afterDraw:e=>{const t=e.getActiveElements();if(t.length>0){const{ctx:a}=e,n=t[0].index;e.data.datasets.forEach(((t,s)=>{const r=e.getDatasetMeta(s).data[n];r&&(a.save(),a.beginPath(),a.arc(r.x,r.y,7,0,2*Math.PI),a.fillStyle="white",a.fill(),a.closePath(),a.beginPath(),a.arc(r.x,r.y,5,0,2*Math.PI),a.fillStyle=t.borderColor,a.fill(),a.closePath(),a.restore())}));const s=e.getDatasetMeta(0).data[n];if(s){a.save();const t=s.x,n=e.chartArea.top;a.beginPath(),a.arc(t,n,7,0,2*Math.PI),a.fillStyle="white",a.fill(),a.closePath(),a.beginPath(),a.arc(t,n,5,0,2*Math.PI),a.fillStyle="#002851",a.fill(),a.closePath(),a.textAlign="center",a.textBaseline="bottom",a.fillStyle="#002851",a.font="bold 12px Inter",a.fillText("Target Age",t,n-8),a.restore()}}}},b={type:"line",data:{labels:c,datasets:[l,u]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{point:{radius:0,hoverRadius:0}},scales:{x:{beginAtZero:!1,border:{display:!0,color:"#0A5999",width:2},grid:{display:!1,drawOnChartArea:!1,drawBorder:!1,drawTicks:!1,offset:!1},title:{display:!0,text:"AGE",color:"#0A5999",font:{size:r?12:16,weight:"bold"}},ticks:{color:"#0A5999",size:12,weight:"bold",family:"Inter",autoSkip:!1,padding:r?10:18,rotation:0,minRotation:0,maxRotation:0,align:"start",crossAlign:"far"}},y:{beginAtZero:!1,grid:{display:!0,color:"#CCEAF7",drawBorder:!1,drawTicks:!1,offset:!1},border:{display:!0,color:"#0A5999",width:2},ticks:{padding:0,color:"#0A5999",size:r?10:12,weight:"bold",family:"Inter",callback:e=>formatCurrencyShort(e),padding:8},title:{display:!1}}},layout:{padding:{top:24,bottom:r?0:10,left:r?0:10,right:r?0:10}}},plugins:[y,g]},h={type:"line",data:{labels:c,datasets:[l,u]},options:{responsive:!0,maintainAspectRatio:!1,events:["mousemove","mouseout","click","touchstart","touchmove"],plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{point:{radius:0,hoverRadius:0}},hover:{mode:"index",intersect:!1,enabled:!0},scales:{x:{beginAtZero:!1,border:{display:!0,color:"#0A5999",width:2},grid:{display:!1,drawOnChartArea:!1,drawBorder:!1,drawTicks:!1,offset:!1},title:{display:!0,text:"AGE",color:"#0A5999",padding:10,font:{size:8,weight:"bold"}},ticks:{display:!1}},y:{beginAtZero:!1,grid:{display:!0,color:"#CCEAF7",drawBorder:!1,drawTicks:!1,offset:!1},border:{display:!0,color:"#0A5999",width:2},ticks:{display:!1},title:{display:!1}}},layout:{padding:{top:0,right:0,bottom:0,left:1}}}};displayGoldLine&&(b.data.datasets.push(d),h.data.datasets.push(d)),chartInited?(chart.data.labels=c,chart.data.datasets=b.data.datasets,chart.options=b.options,chart.update("none"),overviewChart.data.labels=c,overviewChart.data.datasets=h.data.datasets,overviewChart.options=h.options,overviewChart.update("none")):(chart=new Chart(p,b),overviewChart=new Chart(m,h),chartInited=!0)};
