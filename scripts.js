const chartHeight=32;let fixedBarCount=49;const optimalValues={};let displayGoldLine=!1,goldLineEqual=!1,annualCustomAsset1Savings={},annualCustomAsset2Savings={},annualCustomAsset3Savings={},annualCustomAsset4Savings={},annualCustomAsset5Savings={};const calcSelectors=["retirement-age","expectancy","expected-stocks","expected-bonds","expected-btc","expected-cash","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate",],calcElementsAndRanges=[],inputValues={},onlyNumbers=e=>+String(e).replace(/\D/g,""),formatPercent=e=>`${e}%`,formatToFixed=(e,t=0)=>+e.toFixed(t),formatCurrencyShort=(e,t=0)=>e>=1e12?`$${(e/1e12).toFixed(1)}T`:e>=1e9?`$${(e/1e9).toFixed(1)}B`:e>=1e6?`$${(e/1e6).toFixed(t)}M`:e>=1e3?`$${(e/1e3).toFixed()}K`:`$${e}`,formatCurrency=(e,t=0)=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:t,maximumFractionDigits:t}).format(e),getBitcoinPrice=async()=>{try{let e=await fetch("https://blockchain.info/ticker"),t=await e.json(),a=t.USD.last;currentBtcPrice=a,console.log(`Current Bitcoin Price in USD: $${a}`)}catch(r){console.error("Error fetching Bitcoin price:",r)}},updateRangeSliderScale=(e,t,a,r,n,s,l)=>{let c=(r-a)/(fixedBarCount-1),u=Math.round((n-a)/c);if(l===u)return"#E9EBF2";if(s){if(l<u){let o=(u-l)/u,d=.24+.6*o;return`rgba(57, 158, 106, ${Math.min(d,1)})`}{let p=(l-u)/(fixedBarCount-u),m=.24+.6*p;return`rgba(255, 91, 59, ${Math.min(m,1)})`}}if(l<u){let y=(u-l)/u,V=.24+.6*y;return`rgba(255, 91, 59, ${Math.min(V,1)})`}{let g=(l-u)/(fixedBarCount-u),b=.24+.6*g;return`rgba(57, 158, 106, ${Math.min(b,1)})`}},updateAllRangesliders=()=>{calcElementsAndRanges.forEach(e=>{let{selector:t,slider:a,min:r,max:n,step:s}=e,l=+a.value,c=(n-r)/(fixedBarCount-1),u=optimalValues[t],o=optimalValues[`${t}-reversed`],d=optimalValues[`${t}-bars`];d.attr("fill",(e,t)=>{let a=r+c*t;return updateRangeSliderScale(a,l,r,n,u,o,t)})})},updateHandle=(e,t)=>{let a=document.querySelector(`#${e} .calc__slider__scale__item.is--mid`),r=document.querySelector(`#${e} input[type="range"]`),n=(t-r.min)/(r.max-r.min),s=r.offsetWidth,l=n*s,c=100*n;"true"===a.getAttribute("is-percent")?a.innerText=formatPercent(t):"true"===a.getAttribute("is-usd")?a.innerText=formatCurrencyShort(t):a.innerText=onlyNumbers(t),c>97&&(a.nextElementSibling.style.opacity=0),c<3&&(a.previousElementSibling.style.opacity=0),c>3&&c<97&&(a.nextElementSibling.style.opacity=1,a.previousElementSibling.style.opacity=1),a.style.left=l+"px",a.style.transform=`translateX(-${c}%)`},initRangeSliders=()=>{calcSelectors.forEach(e=>{let t=document.querySelector(`#${e}`);if(!t){console.error(`Slider container not found for selector: ${e}`);return}let a=t.querySelector(".calc__graph");if(!a){console.error(`Graph container not found for selector: ${e}`);return}let r=a.clientWidth,n=window.innerWidth<768?3:4,s=d3.select(a).append("svg").attr("width",r).attr("height",32),l=t.querySelector(".calc__slider-range");if(!l){console.error(`Slider not found for selector: ${e}`);return}l.min,l.max;let c=d3.range(fixedBarCount),u=(r-n*(fixedBarCount-1))/fixedBarCount,o=d3.scaleBand().domain(c).range([0,r]).paddingInner(n/(u+n)),d=s.selectAll("rect").data(c).enter().append("rect").attr("x",e=>o(e)).attr("y",0).attr("width",u).attr("height",32);optimalValues[`${e}-bars`]=d;let p=()=>{let t=+l.value;updateAllRangesliders(),updateHandle(e,t)},m;l.addEventListener("input",()=>{clearTimeout(m),m=setTimeout(()=>{let a=l.value,r=t.querySelector(`#${e}-i`);"retirement-age"===e&&a<inputValues["current-age"]&&(a=inputValues["current-age"],l.value=a),inputValues[e]=onlyNumbers(a),p(),r&&("true"===r.getAttribute("is-percent")?r.value=formatPercent(a):"true"===r.getAttribute("is-usd")?r.value=formatCurrency(a):r.value=onlyNumbers(a)),runCalculations()},10)}),p();let y=()=>{r=a.clientWidth;let e=(r-n*(fixedBarCount-1))/fixedBarCount;o.range([0,r]),d.attr("x",e=>o(e)).attr("width",e),p()},V;window.addEventListener("resize",()=>{clearTimeout(V),V=setTimeout(y,100)});let g=t.querySelector(`#${e}-i`);g&&g.addEventListener("blur",()=>{setTimeout(()=>{inputValues[e]=onlyNumbers(g.value),l.value=onlyNumbers(g.value),p()},10)})})};window.addEventListener("load",async()=>{await getBitcoinPrice();let e={},t=new URLSearchParams(window.location.search);for(let[a,r]of t)e[a]=r;window.innerWidth<768&&(fixedBarCount=35),initRangeSliders(),calcSelectors.forEach(t=>{let a=document.querySelector(`#${t} .calc__slider-range`);calcElementsAndRanges.push({selector:t,slider:a,element:a,min:+a.getAttribute("min"),max:+a.getAttribute("max"),step:+a.getAttribute("step")}),a&&(e[t]&&(a.value=e[t]),a.dispatchEvent(new Event("input")),runCalculations())});let n=document.querySelectorAll('.calc-field[is-age="true"]'),s=document.querySelector("#retirement-age-i");n.forEach(e=>{let t=+e.getAttribute("max-age"),a=+e.getAttribute("min-age");e.addEventListener("input",()=>{e.value=onlyNumbers(e.value)}),e.addEventListener("blur",()=>{let r=onlyNumbers(e.value);r>t&&(r=t),r<a&&(r=a),"retirement-age-i"===e.id&&e.value<inputValues["current-age"]&&(r=inputValues["current-age"]),"current-age"===e.id&&e.value>inputValues["retirement-age"]&&(s.value=r,s.dispatchEvent(new Event("blur"))),e.value=r,inputValues[e.id]=r;let n=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");n?(n.value=r,n.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"max age: ",t,"min age:",a,"used value: ",r)})});let l=document.querySelectorAll('.calc-field[is-percent="true"]');l.forEach(e=>{let t=+e.getAttribute("max-percent"),a=+e.getAttribute("min-percent");e.addEventListener("blur",()=>{let r=onlyNumbers(e.value);r>t&&(r=t),r<a&&(r=a),e.value=formatPercent(r),inputValues[e.id]=r/100;let n=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");n?(n.value=r,n.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"only numbers: ",onlyNumbers(e.value),"used value: ",r/100)})});let c=document.querySelectorAll('.calc-field[is-usd="true"]');c.forEach(e=>{let t=+e.getAttribute("max-usd"),a=+e.getAttribute("min-usd");e.addEventListener("blur",()=>{let r=onlyNumbers(e.value);r>t&&(r=t),r<a&&(r=a),e.value=formatCurrency(r),inputValues[e.id]=r;let n=e.closest(".calc-range__wrap")?.querySelector(".calc__slider-range");n?(n.value=r,n.dispatchEvent(new Event("input"))):runCalculations(),console.log(e.id,"input value: ",e.value,"only numbers: ",onlyNumbers(e.value),"used value: ",r)})}),document.querySelectorAll(".calc-radio input").forEach(e=>{e.addEventListener("change",()=>{inputValues[e.name]=e.value,runCalculations(),console.log(e.name,"radio value: ",e.value)})}),document.querySelectorAll("input[init-value]").forEach(t=>{t.value=e[t.id]||t.getAttribute("init-value"),t.dispatchEvent(new Event("blur")),runCalculations()}),document.querySelectorAll('.calc-radio input[name="plan-type"]').forEach(e=>{e.addEventListener("change",()=>{let e=document.querySelector('.calc-radio input[name="plan-type"]:checked').value;"custom"===e?document.querySelector("#expected-btc").classList.remove("is--disabled"):document.querySelector("#expected-btc").classList.add("is--disabled")})}),document.querySelectorAll("input[type='radio'][radio-initial='true']").forEach(t=>{let a=e[t.name],r=t.value;if(a===r)t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0}));else{let n=t.closest(".calc-layout__radios").querySelector(`input[value="${a}"]`);n?(n.checked=!0,n.dispatchEvent(new Event("change",{bubbles:!0}))):(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})))}runCalculations()}),document.querySelector("#share-btn").addEventListener("click",function(){let e=this.textContent;this.textContent="Copied!",setTimeout(()=>this.textContent=e,2e3);let t=new URL(window.location.href),a=new URLSearchParams;["current-age","retirement-age","expectancy","balance-stocks","balance-bonds","balance-btc","additional-stocks","additional-bonds","additional-btc","expected-stocks","expected-bonds","expected-btc","plan-type","expected-cash","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate","custom-additional-1","custom-amount-1","custom-asset-1","custom-status-1","custom-additional-2","custom-amount-2","custom-asset-2","custom-status-2","custom-additional-3","custom-amount-3","custom-asset-3","custom-status-3","custom-additional-4","custom-amount-4","custom-asset-4","custom-status-4","custom-additional-5","custom-amount-5","custom-asset-5","custom-status-5",].forEach(e=>(inputValues[e]||0==inputValues[e])&&a.append(e,inputValues[e])),t.search=a.toString(),navigator.clipboard.writeText(t.toString())}),document.querySelector("#reset-btn").addEventListener("click",()=>{document.querySelectorAll("input[init-value]").forEach(e=>{e.value=e.getAttribute("init-value"),e.dispatchEvent(new Event("blur"))}),calcSelectors.forEach(e=>{let t=document.querySelector(`#${e} .calc__slider-range`);t&&(t.value=t.getAttribute("value"),t.dispatchEvent(new Event("input")))}),document.querySelectorAll("input[type='radio'][radio-initial='true']").forEach(e=>{e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0}))}),document.querySelectorAll(".calc-layout__custom__controls-icon.is--remove").forEach(e=>g(e)),document.querySelectorAll('.calc-layout__custom[custom-value-order="1"] .calc-dropdown').forEach((e,t)=>{let a=e.querySelector(".calc-dropdown__toggle__text"),r=e.querySelector('.calc-dropdown__list__item[initial-value="true"]');a.textContent=r.textContent,0===t&&(inputValues["custom-asset-1"]=r.getAttribute("dropdown-value")),1===t&&(inputValues["custom-status-1"]=r.getAttribute("dropdown-value"))}),runCalculations()});let u=document.querySelector(".secondary-popup"),o=document.querySelector(".secondary-popup .popup__close"),d=document.querySelector(".secondary-popup .popup__overlay"),p=0,m=!1;document.addEventListener("click",()=>{m||10!=++p||(u.classList.add("show"),setTimeout(()=>u.classList.add("fade"),10),m=!0)}),[o,d].forEach(e=>{e.addEventListener("click",()=>{u.classList.remove("fade"),setTimeout(()=>u.classList.remove("show"),300)})});let y=1,V=()=>{let e=document.querySelector("#add-asset-btn"),t=document.querySelectorAll(".calc-layout__custom"),a=document.querySelector(".calc-layout__custom:not(.is--active)");if(!a)return;t.forEach(e=>e.classList.remove("is--last")),a.classList.add("is--active");let r=document.querySelectorAll(".calc-layout__custom.is--active");5===r.length&&e.classList.add("hidden"),a.style.order=y,y++},g=e=>{let t=document.querySelector("#add-asset-btn"),a=e.closest(".calc-layout__custom"),r=a.getAttribute("custom-value-order");a.querySelectorAll(".calc-dropdown__toggle__text").forEach(e=>e.textContent=e.getAttribute("initial-toggle-text")),a.querySelectorAll("input.calc-field").forEach(e=>e.value="$"+e.getAttribute("init-value")),inputValues[`custom-asset-${r}`]=0,inputValues[`custom-status-${r}`]=0,inputValues[`custom-amount-${r}`]=0,inputValues[`custom-additional-${r}`]=0,a.classList.remove("is--active","is--last"),document.querySelectorAll(".calc-layout__custom").forEach(e=>e.classList.remove("is--last"));let n=document.querySelectorAll(".calc-layout__custom.is--active"),s=-2,l;n.forEach(e=>{let t=+e.style.order;t>s&&(s=t,l=e)}),l.classList.add("is--last"),t.classList.remove("hidden"),runCalculations()},b=1;document.querySelectorAll(".calc-dropdown__list.is--initial").forEach(function(t){let a=t.closest(".calc-layout__custom").getAttribute("custom-value-order"),r=t.closest(".calc-dropdown").querySelector(".calc-dropdown__toggle__text"),n=t.getAttribute("custom-value-type");t.addEventListener("click",function(e){if(!e.target.classList.contains("calc-dropdown__list__item"))return;r&&(r.textContent=e.target.textContent);let t=e.target.getAttribute("dropdown-value");inputValues[`custom-${n}-${a}`]=t,$(".calc-dropdown").trigger("w-close"),runCalculations()});let s=e[`custom-${n}-${a}`]||!1;if("1"===a)s?(r&&(r.textContent=t.querySelector(`.calc-dropdown__list__item[dropdown-value="${s}"]`).textContent),inputValues[`custom-${n}-1`]=s):(r&&(r.textContent=t.querySelector('.calc-dropdown__list__item[initial-value="true"]').textContent),inputValues[`custom-${n}-1`]=t.querySelector('.calc-dropdown__list__item[initial-value="true"]').getAttribute("dropdown-value"));else if(a&&s){let l=Number(a);l%2!=0&&b!==l&&(V(),b=l);let c=t.querySelector(`.calc-dropdown__list__item[dropdown-value="${s}"]`);c&&r&&(r.textContent=c.textContent,inputValues[`custom-${n}-${a}`]=s)}t.classList.remove("is--initial")}),document.querySelector("#add-asset-btn")?.addEventListener("click",V),document.querySelectorAll(".calc-layout__custom__controls-icon.is--remove").forEach(e=>{e.addEventListener("click",function(){g(e)})}),document.addEventListener("pointerup",()=>{let e=document.activeElement;e&&"INPUT"===e.tagName&&"range"===e.type&&e.blur()}),document.addEventListener("touchend",()=>{let e=document.activeElement;e&&"INPUT"===e.tagName&&"range"===e.type&&e.blur()}),window.dispatchEvent(new Event("resize"))});const btcPricesS2F={2023:83667.67557239954,2024:686398.0127483337,2025:703741.9524243205,2026:721375.6236071566,2027:739301.4262968419,2028:5986997.015654025,2029:6060174.083947013,2030:6133945.0152537,2031:6208312.209574085,2032:49965761.24291532,2033:50266224.53526536,2034:50567889.953642786,2035:50870759.89804761,2036:408181178.5400824,2037:409398694.1478387,2038:410618628.40764976,2039:411840983.7195157,2040:3299624560.159754,2041:3304526099.867491,2042:3309432491.2793384,2043:3314343736.795295,2044:26534409444.738514,2045:26554078710.52289,2046:26573757694.115482,2047:26593446397.916298,2048:212826355165.1583,2049:212905158594.60263,2050:212983981474.06342,2051:213062823805.94064,2052:1704818018138.2832,2053:1705133484741.0745,2054:1705448990258.2983,2055:1705764534692.3552,2056:13647378572031.568,2057:13648640944365.16,2058:13649903394542.018,2059:13651165922564.541,2060:109214377726149.42,2061:109219428227481.05,2062:109224478884513.6,2063:109229529697249.48,2064:873856441296055.4,2065:873876645325528.8,2066:873896849666418.5,2067:873917054318726.8,2068:6991417254093309,2069:6991498074259649,2070:6991578895048836,2071:6991659716460872,2072:0xc6b75053c21058,2073:0xc6b79b99451880,2074:0xc6b7e6dedb22a8,2075:0xc6b83224842ee8,2076:0x635c2be3afeae80,2077:0x635c3eb5201ea00,2078:0x635c518692b2940,2079:0x635c645807a6d00,2080:357985909114264e4,2081:0x31ae3b94bf7da600,2082:0x31ae40491dc4d200,2083:0x31ae44fd7c580600,2084:28639017565401715e3,2085:2863903825633595e4,2086:2863905894728015e4,2087:28639079638234317e3,2088:2291127198697211e5,2089:2291128026335876e5,2090:229112885397474e6,2091:22911296816138034e4,2092:1832904076346728e6,2093:1832904407402453e6,2094:1832904738458218e6,2095:1832905069514023e6,2096:14663241880335521e6,2097:14663243204558938e6,2098:14663244528782437e6,2099:14663245853006015e6,2100:11730597212094267e7,2101:11730597741783739e7,2102:11730598271473226e7,2103:1173059880116273e8,2104:9384479252805988e8,2105:9384479464681798e8,2106:938447967655761e9,2107:9384479888433425e8,2108:7507583995497068e9,2109:7507584080247396e9,2110:7507584164997724e9,2111:7507584249748053e9,2112:6006067433698574e10,2113:60060674675987065e9,2114:6006067501498839e10,2115:6006067535398971e10,2116:48048540418792296e10,2117:48048540554392825e10,2118:4804854068999335e11,2119:4804854082559388e11,2120:38438832714715317e11,2121:3843883276895553e12,2122:38438832823195746e11,2123:3843883287743595e12,2124:3075106632364485e13,2125:3075106634586495e13,2126:3075106636808505e13,2127:3075106639030515e13,2128:2460085306062612e14,2129:2460085306646612e14,2130:2460085307230612e14,2131:2460085307814612e14,2132:19680682457644895e14,2133:19680682458004896e14,2134:19680682458364897e14,2135:19680682458724895e14,2136:15744545966091917e15,2137:15744545966101917e15,2138:15744545966111917e15,2139:15744545966121917e15,2140:12595636772888455e16,2141:12595636772889454e16,2142:12595636772890454e16,2143:12595636772891456e16,2144:10076509418312764e17,2145:10076509418312863e17,2146:10076509418312964e17,2147:10076509418313064e17,2148:806120753465051e19,2149:806120753465052e19,2150:806120753465053e19},btcPricesPowerLaw=(()=>{let e=[{time:1,price:.03},{time:2,price:1.17},{time:3,price:9.91},{time:4,price:45.2},{time:5,price:146.7},{time:6,price:383.87},{time:7,price:865.75},{time:8,price:1751.3},{time:9,price:3260.17},{time:10,price:5684.04},{time:11,price:9398.21},{time:12,price:14873.64},{time:13,price:22689.36},{time:14,price:33545.07},{time:15,price:89e3},],t=e.map(({time:e,price:t})=>({x:Math.log(e),y:Math.log(t)})),a=t.length,r=t.reduce((e,t)=>e+t.x,0),n=t.reduce((e,t)=>e+t.y,0),s=t.reduce((e,t)=>e+t.x*t.y,0),l=t.reduce((e,t)=>e+t.x*t.x,0),c=(a*s-r*n)/(a*l-r*r),u=Math.exp((n-c*r)/a),o={};for(let d=0;d<150;d++){let p=2010+d;o[p]=u*Math.pow(d+1,c)}return o})(),currentYear=new Date().getFullYear();let currentBtcPrice=65e3;const btcPricesBtc24=()=>{let e=currentYear,t={[e]:currentBtcPrice};for(let a=1;a<=150;a++){let r=Math.max(50-(a-1)*2.5,20),n=t[e+(a-1)],s=e+a;t[s]=n*(1+r/100)}return t},btcPricesCustom=e=>{let t={[currentYear]:currentBtcPrice};for(let a=1;a<=150;a++){let r=t[currentYear+a-1];t[currentYear+a]=r*(1+e/100)}return t},sidebarElements={};document.addEventListener("DOMContentLoaded",()=>{sidebarElements.retireBy=document.querySelector("#res-retire-by"),sidebarElements.portfolioAtRetirement=document.querySelector("#res-portfolio-retirement"),sidebarElements.btcAtRetirement=document.querySelector("#res-btc-retirement"),sidebarElements.btcPriceAtRetirement=document.querySelector("#res-btc-price-retirement"),sidebarElements.monthlyBudget=document.querySelector("#res-budget-monthly"),sidebarElements.annualBudget=document.querySelector("#res-budget-year"),sidebarElements.yearsOfWithdrawals=document.querySelector("#res-years-of-withdrawals"),sidebarElements.portfolioAtDeath=document.querySelector("#res-portfolio-at-death"),sidebarElements.successMessage=document.querySelector('.notification[notification="success"]'),sidebarElements.errorMessage=document.querySelector('.notification[notification="fail"]'),sidebarElements.mobileUnderline=document.querySelector(".calc-mobile__underline")});const runCalculations=()=>{let e=["current-age","balance-stocks","balance-bonds","balance-btc","additional-stocks","additional-bonds","additional-btc","retirement-age","expectancy","expected-stocks","expected-bonds","expected-cash","expected-btc","growth-rate","retirement-income","retirement-expenses","capital-gains","inflation-rate","plan-type"],t=e.filter(e=>!inputValues[e]&&0!==inputValues[e]);if(t.length>0)return;let a=inputValues["current-age"],r=(e,t)=>e[t],n=(e,t)=>e[t],s=(e,t)=>e[t],l=(e,t)=>e[t],c=(e,t)=>e[t],u=(e,t,a)=>{let r=0;for(let n=t;n<=a&&e[n];n++)r++;return r},o=(e,t,a,r=!1,n=!0,s=inputValues["growth-rate"],l=inputValues["inflation-rate"])=>{let c={};c[currentYear]=e;for(let u=1;u<=a;u++){let o=c[currentYear+(u-1)],d=currentYear+u;if(n&&d>t)continue;let p=o*(1+(r?l:s)/100);c[d]=p}return c},d=()=>{let e=0;for(i=1;i<=5;i++)e+=+inputValues[`custom-additional-${i}`]||0;let t=o(e,currentYear+inputValues["retirement-age"]-a,inputValues.expectancy,!1,!0);return t},p=(e,t,a,r,n)=>{switch(e){case"stocks":return(t||0)*(1+inputValues["expected-stocks"]/100)+(a||0)+(r||0);case"bonds":return(t||0)*(1+inputValues["expected-bonds"]/100)+(a||0)+(r||0);case"btc":return(t||0)*n+(a||0)+(r||0);case"other":return(t||0)*(1+inputValues["expected-cash"]/100)+(a||0)+(r||0);default:return t}},m=e=>{let t={};return(t[currentYear]=inputValues["balance-btc"],"btc24"===inputValues["plan-type"])?btcPricesBtc24():"power-law"===inputValues["plan-type"]?btcPricesPowerLaw:"custom"===inputValues["plan-type"]?btcPricesCustom(e):btcPricesS2F},y=(e,t,a,r=inputValues["capital-gains"])=>{let n={};for(let s=1;s<=a;s++){let l=currentYear+s;l>t?n[l]=e[l]/(1-r/100):n[l]=0}return n},V=(e,t,a,r,n,s,o)=>{setTimeout(()=>{let d=l(a,currentYear+(inputValues["retirement-age"]-e));sidebarElements.retireBy&&(sidebarElements.retireBy.value=inputValues["retirement-age"]),sidebarElements.portfolioAtRetirement&&(sidebarElements.portfolioAtRetirement.value=formatCurrency(o)),sidebarElements.btcAtRetirement&&(sidebarElements.btcAtRetirement.value="â‚¿"+formatCurrency(c(t,currentYear+(inputValues["retirement-age"]-e))/d,3).replace("$","")),sidebarElements.btcPriceAtRetirement&&(sidebarElements.btcPriceAtRetirement.value=formatCurrency(d)),sidebarElements.monthlyBudget&&(sidebarElements.monthlyBudget.value=formatCurrency(r/12)),sidebarElements.annualBudget&&(sidebarElements.annualBudget.value=formatCurrency(r)),sidebarElements.yearsOfWithdrawals&&(sidebarElements.yearsOfWithdrawals.value=formatToFixed(u(n,currentYear+(inputValues["retirement-age"]-e),currentYear-e+inputValues.expectancy),1)),sidebarElements.portfolioAtDeath&&(sidebarElements.portfolioAtDeath.value=formatCurrency(s)),s<=0?(sidebarElements.successMessage.classList.add("hidden"),sidebarElements.errorMessage.classList.remove("hidden"),sidebarElements.mobileUnderline.classList.remove("is--green")):(sidebarElements.successMessage.classList.remove("hidden"),sidebarElements.errorMessage.classList.add("hidden"),sidebarElements.mobileUnderline.classList.add("is--green"))},50)},g=(e,t,r,n,s,l,c,u,o,d,y,V,g=!1,b=!1)=>{let x={},f={},h={},v={},E={},S={},L={},w=m(V),A={},q={},C={},Y={},k=o,B=d,R=inputValues["balance-stocks"],P=inputValues["balance-bonds"],F=inputValues["balance-btc"],N=!1,W=inputValues["custom-amount-1"]||0,D=inputValues["custom-amount-2"]||0,T=inputValues["custom-amount-3"]||0,I=inputValues["custom-amount-4"]||0,M=inputValues["custom-amount-5"]||0,G=b?"btc":inputValues["custom-asset-1"],U=b?"btc":inputValues["custom-asset-2"],z=b?"btc":inputValues["custom-asset-3"],O=b?"btc":inputValues["custom-asset-4"],Z=b?"btc":inputValues["custom-asset-5"],H=b&&"none"!==inputValues["custom-status-1"]?"roth":inputValues["custom-status-1"],j=b&&"none"!==inputValues["custom-status-2"]?"roth":inputValues["custom-status-2"],K=b&&"none"!==inputValues["custom-status-3"]?"roth":inputValues["custom-status-3"],X=b&&"none"!==inputValues["custom-status-4"]?"roth":inputValues["custom-status-4"],J=b&&"none"!==inputValues["custom-status-5"]?"roth":inputValues["custom-status-5"],Q={},ee={},et={},ea={},er={},en={},es={},ei={},el={},ec={};if(!b){let eu=("roth"===H&&"btc"===G?W:0)+("roth"===j&&"btc"===U?D:0)+("roth"===K&&"btc"===z?T:0)+("roth"===X&&"btc"===O?I:0)+("roth"===J&&"btc"===Z?M:0),eo=W+D+T+I+M,ed=("traditional"==H&&"btc"===G||"none"!==H&&"btc"!==G?W:0)+("traditional"==j&&"btc"===U||"none"!==j&&"btc"!==U?D:0)+("traditional"==K&&"btc"===z||"none"!==K&&"btc"!==z?T:0)+("traditional"==X&&"btc"===O||"none"!==X&&"btc"!==O?I:0)+("traditional"==J&&"btc"===Z||"none"!==J&&"btc"!==Z?M:0);eo>0&&eu===eo?goldLineEqual=displayGoldLine=!0:ed>0?(goldLineEqual=!1,displayGoldLine=!0):(goldLineEqual=!1,displayGoldLine=!1)}x[currentYear]=P+R+F+W+D+T+I+M,f[currentYear]=F,v[currentYear]=R,S[currentYear]=P,Q[currentYear]=W,ee[currentYear]=D,et[currentYear]=T,ea[currentYear]=I,er[currentYear]=M,q[currentYear]=x[currentYear],C[currentYear]=.6*x[currentYear],Y[currentYear]=.4*x[currentYear];for(let e$=1;e$<=c;e$++){let ep=currentYear+e$,e_=a+e$,em=w[ep],e0=x[ep-1]||0,ey=g&&e_<=inputValues.expectancy,eV=0,eg=0,eb=0,e2=0,e3=0,e1=0,ex=0,e4=0,ef=Math.max(e[ep]-t[ep-1]||0,0);if(t[ep-1],e[ep],ep>u&&e0>0){if(0!==ef){let eh=f[ep-1]||0,e7=v[ep-1]||0,e6=S[ep-1]||0,e5=Q[ep-1]||0,ev=ee[ep-1]||0,eE=et[ep-1]||0,e8=ea[ep-1]||0,eS=er[ep-1]||0,eL=Math.max(e0-("roth"===H?e5:0)-("roth"===j?ev:0)-("roth"===K?eE:0)-("roth"===X?e8:0)-("roth"===J?eS:0),0);if(e_>=60||e_<60&&eL>=ef){N=!1;let ew=ef,eA=[{balance:eh||0,proportion:0,sold:0},{balance:e7||0,proportion:0,sold:0},{balance:e6||0,proportion:0,sold:0},{balance:e5||0,proportion:0,sold:0,include:"roth"!==H||e_>=60},{balance:ev||0,proportion:0,sold:0,include:"roth"!==j||e_>=60},{balance:eE||0,proportion:0,sold:0,include:"roth"!==K||e_>=60},{balance:e8||0,proportion:0,sold:0,include:"roth"!==X||e_>=60},{balance:eS||0,proportion:0,sold:0,include:"roth"!==J||e_>=60},].filter(e=>e.balance>0&&!1!==e.include),eq=eA.reduce((e,t)=>e+t.balance,0);if(eq>0){eA.forEach(e=>{e.proportion=e.balance/eq}),eA.forEach(e=>{let t=ew*e.proportion;e.sold=Math.min(t,e.balance)});let eC=eA.reduce((e,t)=>e+t.sold,0);if(eC<ew){let eY=ew-eC,ek=eA.filter(e=>e.sold<e.balance);if(ek.length>0){let e9=ek.reduce((e,t)=>e+(t.balance-t.sold),0);ek.forEach(e=>{let t=(e.balance-e.sold)/e9,a=Math.min(eY*t,e.balance-e.sold);e.sold+=a})}}}eV=eA.find(e=>e.balance===eh)?.sold||0,eg=eA.find(e=>e.balance===e7)?.sold||0,eb=eA.find(e=>e.balance===e6)?.sold||0,e2=eA.find(e=>e.balance===e5)?.sold||0,e3=eA.find(e=>e.balance===ev)?.sold||0,e1=eA.find(e=>e.balance===eE)?.sold||0,ex=eA.find(e=>e.balance===e8)?.sold||0,e4=eA.find(e=>e.balance===eS)?.sold||0,ef>0&&(eV=Math.min(eV,eh),eg=Math.min(eg,e7),eb=Math.min(eb,e6),e2=Math.min(e2,Q[ep-1]),e3=Math.min(e3,ee[ep-1]),e1=Math.min(e1,et[ep-1]),ex=Math.min(ex,ea[ep-1]),e4=Math.min(e4,er[ep-1]))}else{N=!0;let eB=[{name:"btc",balance:eh||0,isRoth:!1},{name:"stocks",balance:e7||0,isRoth:!1},{name:"bonds",balance:e6||0,isRoth:!1},{name:"custom1",balance:e5||0,isRoth:"roth"===H},{name:"custom2",balance:ev||0,isRoth:"roth"===j},{name:"custom3",balance:eE||0,isRoth:"roth"===K},{name:"custom4",balance:e8||0,isRoth:"roth"===X},{name:"custom5",balance:eS||0,isRoth:"roth"===J},].filter(e=>e.balance>0),eR=ef;eB.forEach(e=>e.sold=0);let eP=eB.filter(e=>!e.isRoth),eF=eP.reduce((e,t)=>e+t.balance,0);if(eF>0){let eN=Math.min(eR,eF);eP.forEach(e=>{let t=e.balance/eF;e.sold=Math.min(eN*t,e.balance)}),eR-=eP.reduce((e,t)=>e+t.sold,0)}if(eR>0){let eW=1.3*eR,eD=eB.filter(e=>e.isRoth),eT=eD.reduce((e,t)=>e+t.balance,0);if(eT>0){let eI=Math.min(eW,eT);eD.forEach(e=>{let t=e.balance/eT;e.sold=Math.min(eI*t,e.balance)})}}eV=eB.find(e=>"btc"===e.name)?.sold||0,eg=eB.find(e=>"stocks"===e.name)?.sold||0,eb=eB.find(e=>"bonds"===e.name)?.sold||0,e2=eB.find(e=>"custom1"===e.name)?.sold||0,e3=eB.find(e=>"custom2"===e.name)?.sold||0,e1=eB.find(e=>"custom3"===e.name)?.sold||0,ex=eB.find(e=>"custom4"===e.name)?.sold||0,e4=eB.find(e=>"custom5"===e.name)?.sold||0,ef>0&&(eV=Math.min(eV,eh),eg=Math.min(eg,e7),eb=Math.min(eb,e6),e2=Math.min(e2,Q[ep-1]),e3=Math.min(e3,ee[ep-1]),e1=Math.min(e1,et[ep-1]),ex=Math.min(ex,ea[ep-1]),e4=Math.min(e4,er[ep-1]))}}}else;if(e0>0){h[ep]=-eV,E[ep]=-eg,L[ep]=-eb,en[ep]=-e2,es[ep]=-e3,ei[ep]=-e1,el[ep]=-ex,ec[ep]=-e4;let eM=em/w[ep-1];f[ep]=(f[ep-1]||0)*eM+(r[ep]||0)+h[ep],v[ep]=(v[ep-1]||0)*(1+k/100)+(n[ep]||0)+E[ep],S[ep]=(S[ep-1]||0)*(1+B/100)+(s[ep]||0)+L[ep],Q[ep]=p(G,Q[ep-1],l[ep],en[ep],eM),ee[ep]=p(U,ee[ep-1],l[ep],es[ep],eM),et[ep]=p(z,et[ep-1],l[ep],ei[ep],eM),ea[ep]=p(O,ea[ep-1],l[ep],el[ep],eM),er[ep]=p(Z,er[ep-1],l[ep],ec[ep],eM),e0>ef?(x[ep]=Math.max(f[ep]+v[ep]+S[ep]+Q[ep]+ee[ep]+et[ep]+ea[ep]+er[ep]),ey):x[ep]=0}else f[ep]=0,v[ep]=0,S[ep]=0,x[ep]=0,Q[ep]=0,ee[ep]=0,et[ep]=0,ea[ep]=0,er[ep]=0;e0>ef?A[ep]=!0:A[ep]=!1;let eG=C[ep-1]*(1+k/100),eU=Y[ep-1]*(1+B/100),ez=eG+eU,eO=ef,eZ=.5*eO,eH=.5*eO;ep>u?q[ep-1]>0&&ef<ez?(C[ep]=eG-eZ,Y[ep]=eU-eH,q[ep]=Math.max(C[ep]+Y[ep],0)):q[ep]=0:(C[ep]=eG,Y[ep]=eU,q[ep]=ez),isNaN(x[ep])&&console.error("NaN detected in year:",ep,{btcBalance:f[ep],stocksBalance:v[ep],bondsBalance:S[ep],totalBalance:x[ep],btcPrice:em,previousBtcPrice:w[ep-1],previousTotalBalance:e0,netWithdrawal:ef,withdrawals:{btc:h[ep],stocks:E[ep],bonds:L[ep],custom1:en[ep],custom2:es[ep],custom3:ei[ep],custom4:el[ep],custom5:ec[ep]}})}return{totalBalances:x,btcBalance:f,btcSold:h,stocksBalance:v,stocksSold:E,bondsBalance:S,bondsSold:L,btcPrices:w,retirementSuccessStatus:A,portfolio60_40:q}},b=o(inputValues["retirement-expenses"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!0,!1);o(inputValues["additional-cash"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!1);let x=o(inputValues["additional-bonds"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),f=o(inputValues["additional-stocks"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),h=d();annualCustomAsset1Savings=o(inputValues["custom-amount-1"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),annualCustomAsset2Savings=o(inputValues["custom-amount-2"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),annualCustomAsset3Savings=o(inputValues["custom-amount-3"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),annualCustomAsset4Savings=o(inputValues["custom-amount-4"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),annualCustomAsset5Savings=o(inputValues["custom-amount-5"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0);let v=o(inputValues["additional-btc"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!1,!0),E=o(inputValues["retirement-income"],currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy,!0,!1),S=y(b,currentYear+(inputValues["retirement-age"]-a),inputValues.expectancy),{totalBalances:L,btcBalance:w,btcSold:A,stocksBalance:q,stocksSold:C,bondsBalance:Y,bondsSold:k,btcPrices:B,retirementSuccessStatus:R,portfolio60_40:P}=g(S,E,v,f,x,h,inputValues.expectancy,currentYear+(inputValues["retirement-age"]-a),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"],!0,!1),F={},{totalBalances:N,btcBalance:W,btcSold:D,stocksBalance:T,stocksSold:I,bondsBalance:M,bondsSold:G,cashIncomeBalance:U,btcPrices:z,retirementSuccessStatus:O,portfolio60_40:Z}=g(S,E,v,f,x,h,inputValues.expectancy,currentYear+(inputValues["retirement-age"]-a),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"],!1,!0);F=N;let H=s(b,currentYear+(inputValues["retirement-age"]-a)),j=r(L,currentYear+(inputValues["retirement-age"]-a)),K=n(L,currentYear-a+inputValues.expectancy),X=()=>{calcElementsAndRanges.forEach(e=>{let t=e.selector,r=e.min,s=e.max,l=e.step;if("retirement-age"===t){let c=document.querySelector(`#${t} .calc-range__info-text.is--red`),u=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let p=r;p<=s;p+=l){let m=currentYear+(p-a),V=o(inputValues["retirement-expenses"],m,inputValues.expectancy,!0,!1),b=y(V,m,inputValues.expectancy),x=o(inputValues["retirement-income"],m,inputValues.expectancy,!0,!1),f=o(inputValues["additional-btc"],m,inputValues.expectancy,!1,!0),h=o(inputValues["additional-stocks"],m,inputValues.expectancy,!1,!0),v=o(inputValues["additional-bonds"],m,inputValues.expectancy,!1,!0),E=d(),{totalBalances:S}=g(b,x,f,h,v,E,inputValues.expectancy,m,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),L=n(S,currentYear-a+inputValues.expectancy);if(L>0){optimalValues[t]=p,u.classList.remove("is--gray"),c.classList.remove("is--gray"),p===r&&c.classList.add("is--gray");break}p>=s&&(optimalValues[t]=s,c.classList.remove("is--gray"),u.classList.add("is--gray"))}optimalValues["retirement-age-reversed"]=!1}else if("expectancy"===t){let w=document.querySelector(`#${t} .calc-range__info-text.is--red`),A=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let q=r;q<=s;q+=l){let C=currentYear-a+q,Y=o(inputValues["retirement-expenses"],currentYear+(inputValues["retirement-age"]-a),q,!0,!1),k=y(Y,currentYear+(inputValues["retirement-age"]-a),q),B=o(inputValues["retirement-income"],currentYear+(inputValues["retirement-age"]-a),q,!0,!1),R=o(inputValues["additional-btc"],currentYear+(inputValues["retirement-age"]-a),q,!1,!0),P=o(inputValues["additional-stocks"],currentYear+(inputValues["retirement-age"]-a),q,!1,!0),F=o(inputValues["additional-bonds"],currentYear+(inputValues["retirement-age"]-a),q,!1,!0),N=d(),{totalBalances:W}=g(k,B,R,P,F,N,q,currentYear+(inputValues["retirement-age"]-a),inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),D=n(W,C);if(D<=0){optimalValues[t]=q-1,A.classList.remove("is--gray"),w.classList.remove("is--gray"),q===r&&A.classList.add("is--gray");break}q>=s&&(optimalValues[t]=s,w.classList.add("is--gray"),A.classList.remove("is--gray"))}optimalValues["expectancy-reversed"]=!0}else if("expected-stocks"===t){let T=document.querySelector(`#${t} .calc-range__info-text.is--red`),I=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let M=r;M<=s;M+=l){let G=currentYear+(inputValues["retirement-age"]-a),U=o(inputValues["retirement-expenses"],G,inputValues.expectancy,!0,!1),z=y(U,G,inputValues.expectancy),O=o(inputValues["retirement-income"],G,inputValues.expectancy,!0,!1),Z=o(inputValues["additional-btc"],G,inputValues.expectancy,!1,!0),H=o(inputValues["additional-stocks"],G,inputValues.expectancy,!1,!0),j=o(inputValues["additional-bonds"],G,inputValues.expectancy,!1,!0),K=d(),{totalBalances:X}=g(z,O,Z,H,j,K,inputValues.expectancy,G,M,inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),J=n(X,currentYear-a+inputValues.expectancy);if(J>0){optimalValues[t]=M,I.classList.remove("is--gray"),T.classList.remove("is--gray"),M===r&&T.classList.add("is--gray");break}M>=s&&(optimalValues[t]=s,T.classList.remove("is--gray"),I.classList.add("is--gray"))}optimalValues["expected-stocks-reversed"]=!1}else if("expected-bonds"===t){let Q=document.querySelector(`#${t} .calc-range__info-text.is--red`),ee=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let et=r;et<=s;et+=l){let ea=currentYear+(inputValues["retirement-age"]-a),er=o(inputValues["retirement-expenses"],ea,inputValues.expectancy,!0,!1),en=y(er,ea,inputValues.expectancy),es=o(inputValues["retirement-income"],ea,inputValues.expectancy,!0,!1),ei=o(inputValues["additional-btc"],ea,inputValues.expectancy,!1,!0),el=o(inputValues["additional-stocks"],ea,inputValues.expectancy,!1,!0),ec=o(inputValues["additional-bonds"],ea,inputValues.expectancy,!1,!0),eu=d(),{totalBalances:eo}=g(en,es,ei,el,ec,eu,inputValues.expectancy,ea,inputValues["expected-stocks"],et,inputValues["expected-cash"],inputValues["expected-btc"]),ed=n(eo,currentYear-a+inputValues.expectancy);if(ed>0){optimalValues[t]=et,ee.classList.remove("is--gray"),Q.classList.remove("is--gray"),et===r&&Q.classList.add("is--gray");break}et>=s&&(optimalValues[t]=s,Q.classList.remove("is--gray"),ee.classList.add("is--gray"))}optimalValues["expected-bonds-reversed"]=!1}else if("expected-cash"===t){let e$=document.querySelector(`#${t} .calc-range__info-text.is--red`),ep=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let e_=r;e_<=s;e_+=l){let em=currentYear+(inputValues["retirement-age"]-a),e0=o(inputValues["retirement-expenses"],em,inputValues.expectancy,!0,!1),ey=y(e0,em,inputValues.expectancy),eV=o(inputValues["retirement-income"],em,inputValues.expectancy,!0,!1),eg=o(inputValues["additional-btc"],em,inputValues.expectancy,!1,!0),eb=o(inputValues["additional-stocks"],em,inputValues.expectancy,!1,!0),e2=o(inputValues["additional-bonds"],em,inputValues.expectancy,!1,!0),e3=d(),{totalBalances:e1}=g(ey,eV,eg,eb,e2,e3,inputValues.expectancy,em,inputValues["expected-stocks"],inputValues["expected-bonds"],e_,inputValues["expected-btc"]),ex=n(e1,currentYear-a+inputValues.expectancy);if(ex>0){optimalValues[t]=e_,ep.classList.remove("is--gray"),e$.classList.remove("is--gray"),e_===r&&e$.classList.add("is--gray");break}e_>=s&&(optimalValues[t]=s,e$.classList.remove("is--gray"),ep.classList.add("is--gray"))}optimalValues["expected-cash-reversed"]=!1}else if("expected-btc"===t){let e4=document.querySelector(`#${t} .calc-range__info-text.is--red`),ef=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let eh=r;eh<=s;eh+=l){let e7=currentYear+(inputValues["retirement-age"]-a),e6=o(inputValues["retirement-expenses"],e7,inputValues.expectancy,!0,!1),e5=y(e6,e7,inputValues.expectancy),ev=o(inputValues["retirement-income"],e7,inputValues.expectancy,!0,!1),eE=o(inputValues["additional-btc"],e7,inputValues.expectancy,!1,!0),e8=o(inputValues["additional-stocks"],e7,inputValues.expectancy,!1,!0),eS=o(inputValues["additional-bonds"],e7,inputValues.expectancy,!1,!0),eL=d(),{totalBalances:ew}=g(e5,ev,eE,e8,eS,eL,inputValues.expectancy,e7,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],eh),eA=n(ew,currentYear-a+inputValues.expectancy);if(eA>0){optimalValues[t]=eh,ef.classList.remove("is--gray"),e4.classList.remove("is--gray"),eh===r&&e4.classList.add("is--gray");break}eh>=s&&(optimalValues[t]=s,e4.classList.remove("is--gray"),ef.classList.add("is--gray"))}optimalValues["expected-btc-reversed"]=!1}else if("growth-rate"===t){let eq=document.querySelector(`#${t} .calc-range__info-text.is--red`),eC=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let eY=r;eY<=s;eY+=l){let ek=currentYear+(inputValues["retirement-age"]-a),e9=o(inputValues["retirement-expenses"],ek,inputValues.expectancy,!0,!1,eY),eB=y(e9,ek,inputValues.expectancy),eR=o(inputValues["retirement-income"],ek,inputValues.expectancy,!0,!1,eY),eP=o(inputValues["additional-btc"],ek,inputValues.expectancy,!1,!0,eY),eF=o(inputValues["additional-stocks"],ek,inputValues.expectancy,!1,!0,eY),eN=o(inputValues["additional-bonds"],ek,inputValues.expectancy,!1,!0,eY),eW=d(),{totalBalances:eD}=g(eB,eR,eP,eF,eN,eW,inputValues.expectancy,ek,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),eT=n(eD,currentYear-a+inputValues.expectancy);if(eT>0){optimalValues[t]=eY,eC.classList.remove("is--gray"),eq.classList.remove("is--gray"),eY===r&&eq.classList.add("is--gray");break}eY>=s&&(optimalValues[t]=s,eq.classList.remove("is--gray"),eC.classList.add("is--gray"))}optimalValues["growth-rate-reversed"]=!1}else if("retirement-income"===t){let eI=document.querySelector(`#${t} .calc-range__info-text.is--red`),eM=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let eG=r;eG<=s;eG+=2*l){let eU=currentYear+(inputValues["retirement-age"]-a),ez=o(inputValues["retirement-expenses"],eU,inputValues.expectancy,!0,!1),eO=y(ez,eU,inputValues.expectancy),eZ=o(eG,eU,inputValues.expectancy,!0,!1),eH=o(inputValues["additional-btc"],eU,inputValues.expectancy,!1,!0),ej=o(inputValues["additional-stocks"],eU,inputValues.expectancy,!1,!0),eK=o(inputValues["additional-bonds"],eU,inputValues.expectancy,!1,!0),eX=d(),{totalBalances:eJ}=g(eO,eZ,eH,ej,eK,eX,inputValues.expectancy,eU,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),eQ=n(eJ,currentYear-a+inputValues.expectancy);if(eQ>0){optimalValues[t]=eG,eM.classList.remove("is--gray"),eI.classList.remove("is--gray"),eG===r&&eI.classList.add("is--gray");break}eG>=s&&(optimalValues[t]=s,eI.classList.remove("is--gray"),eM.classList.add("is--gray"))}optimalValues["retirement-income-reversed"]=!1}else if("retirement-expenses"===t){let te=document.querySelector(`#${t} .calc-range__info-text.is--red`),tt=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let ta=r;ta<=s;ta+=2*l){let tr=currentYear+(inputValues["retirement-age"]-a),tn=o(ta,tr,inputValues.expectancy,!0,!1),ts=y(tn,tr,inputValues.expectancy),ti=o(inputValues["retirement-income"],tr,inputValues.expectancy,!0,!1),tl=o(inputValues["additional-btc"],tr,inputValues.expectancy,!1,!0),tc=o(inputValues["additional-stocks"],tr,inputValues.expectancy,!1,!0),tu=o(inputValues["additional-bonds"],tr,inputValues.expectancy,!1,!0),to=d(),{totalBalances:td}=g(ts,ti,tl,tc,tu,to,inputValues.expectancy,tr,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),t$=n(td,currentYear-a+inputValues.expectancy);if(t$<=0){optimalValues[t]=ta-1,tt.classList.remove("is--gray"),te.classList.remove("is--gray"),ta===r&&tt.classList.add("is--gray");break}ta>=s&&(optimalValues[t]=s,te.classList.add("is--gray"),tt.classList.remove("is--gray"))}optimalValues["retirement-expenses-reversed"]=!0}else if("capital-gains"===t){let tp=document.querySelector(`#${t} .calc-range__info-text.is--red`),t_=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let tm=r;tm<=s;tm+=l){let t0=currentYear+(inputValues["retirement-age"]-a),ty=o(inputValues["retirement-expenses"],t0,inputValues.expectancy,!0,!1),tV=y(ty,t0,inputValues.expectancy,tm),tg=o(inputValues["retirement-income"],t0,inputValues.expectancy,!0,!1),tb=o(inputValues["additional-btc"],t0,inputValues.expectancy,!1,!0),t2=o(inputValues["additional-stocks"],t0,inputValues.expectancy,!1,!0),t3=o(inputValues["additional-bonds"],t0,inputValues.expectancy,!1,!0),t1=d(),{totalBalances:tx}=g(tV,tg,tb,t2,t3,t1,inputValues.expectancy,t0,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),t4=n(tx,currentYear-a+inputValues.expectancy);if(t4<=0){optimalValues[t]=tm-1,t_.classList.remove("is--gray"),tp.classList.remove("is--gray"),tm===r&&t_.classList.add("is--gray");break}tm>=s&&(optimalValues[t]=s,tp.classList.add("is--gray"),t_.classList.remove("is--gray"))}optimalValues["capital-gains-reversed"]=!0}else if("inflation-rate"===t){let tf=document.querySelector(`#${t} .calc-range__info-text.is--red`),th=document.querySelector(`#${t} .calc-range__info-text.is--green`);for(let t7=r;t7<=s;t7+=l){let t6=currentYear+(inputValues["retirement-age"]-a),t5=o(inputValues["retirement-expenses"],t6,inputValues.expectancy,!0,!1,inputValues["growth-rate"],t7),tv=y(t5,t6,inputValues.expectancy),tE=o(inputValues["retirement-income"],t6,inputValues.expectancy,!0,!1,inputValues["growth-rate"],t7),t8=o(inputValues["additional-btc"],t6,inputValues.expectancy,!1,!0,inputValues["growth-rate"],t7),tS=o(inputValues["additional-stocks"],t6,inputValues.expectancy,!1,!0,inputValues["growth-rate"],t7),tL=o(inputValues["additional-bonds"],t6,inputValues.expectancy,!1,!0,inputValues["growth-rate"],t7),tw=d(),{totalBalances:tA}=g(tv,tE,t8,tS,tL,tw,inputValues.expectancy,t6,inputValues["expected-stocks"],inputValues["expected-bonds"],inputValues["expected-cash"],inputValues["expected-btc"]),tq=n(tA,currentYear-a+inputValues.expectancy);if(tq<=0){optimalValues[t]=t7-1,th.classList.remove("is--gray"),tf.classList.remove("is--gray"),t7===r&&th.classList.add("is--gray");break}t7>=s&&(optimalValues[t]=s,tf.classList.add("is--gray"),th.classList.remove("is--gray"))}optimalValues["inflation-rate-reversed"]=!0}}),updateAllRangesliders()},J=_.throttle(X,100,{trailing:!0});J(),V(a,w,B,H,R,K,j),updateMainChart(L,currentYear-a+inputValues.expectancy,a,P,F)};let chartInited=!1,chart,overviewChart,chartElements={};const updateMainChart=(e,t,a,r,n)=>{chartInited||(chartElements.resultsWrap=document.querySelector(".chart-wrap .chart-info"),chartElements.resultAge=document.querySelector("#chart-res-age"),chartElements.resultBtc=document.querySelector("#chart-res-btc"),chartElements.result60_40=document.querySelector("#chart-res-6040"),chartElements.resultRoth=document.querySelector("#chart-res-roth"),chartElements.rothWrap=document.querySelector(".chart-info #roth-wrap"),chartElements.resultDifference=document.querySelector("#chart-res-diff"));let s=[];for(let l=currentYear;l<=t;l++){let c=a+(l-currentYear);(l-currentYear)%10==0||l===t?s.push(c.toString()):s.push("")}let u=Object.fromEntries(Object.entries(e).filter(([e])=>Number(e)<=t)),o=Object.fromEntries(Object.entries(r).filter(([e])=>Number(e)<=t)),d={data:Object.values(u),borderColor:"#399E6A",fill:!1,borderWidth:2,tension:.4,pointRadius:0},p={data:Object.values(o),borderColor:"#0095D6",backgroundColor:"#CDEFFF33",fill:!0,borderWidth:2,tension:.4,pointRadius:0},m={};if(displayGoldLine){let y=Object.fromEntries(Object.entries(n).filter(([e])=>Number(e)<=t));m={data:Object.values(y),borderColor:"#db9905",fill:!1,borderWidth:2,tension:.4,pointRadius:0},chartElements.rothWrap.classList.remove("hidden")}else chartElements.rothWrap.classList.add("hidden");goldLineEqual?d.borderDash=[10,10]:d.borderDash=[0,0];let V=document.querySelector(".calculator-chart").getContext("2d"),g=document.querySelector(".overview-chart").getContext("2d");Chart.defaults.font.family="Inter, sans-serif",Chart.defaults.font.size=12,Chart.defaults.font.weight=600;let b={id:"corsair",defaults:{width:1,color:"#CCEAF7",dash:[3,3]},afterInit(e,t,a){e.corsair={x:0,y:0}},afterEvent(e,t){let{inChartArea:a}=t,{type:r,x:n,y:s}=t.event;e.corsair={x:n,y:s,draw:a},e.draw()},beforeDatasetsDraw(e,t,a){let{ctx:r}=e,{top:n,bottom:s}=e.chartArea,{x:l,draw:c}=e.corsair;c&&(r.save(),r.beginPath(),r.lineWidth=a.width,r.strokeStyle=a.color,r.moveTo(l,s),r.lineTo(l,n),r.stroke(),r.restore())}},x={type:"line",data:{labels:s,datasets:[d,p]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{point:{radius:0,hoverRadius:0}},scales:{x:{beginAtZero:!1,border:{display:!0,color:"#0A5999",width:2},grid:{display:!1,drawOnChartArea:!1,drawBorder:!1,drawTicks:!1,offset:!1},title:{display:!0,text:"AGE",color:"#0A5999",font:{size:16,weight:"bold"}},ticks:{color:"#0A5999",size:12,weight:"bold",family:"Inter",autoSkip:!1,padding:18,rotation:0,minRotation:0,maxRotation:0,align:"start",crossAlign:"far"}},y:{beginAtZero:!1,grid:{display:!0,color:"#CCEAF7",drawBorder:!1,drawTicks:!1,offset:!1},border:{display:!0,color:"#0A5999",width:2},ticks:{padding:0,color:"#0A5999",size:12,weight:"bold",family:"Inter",callback:e=>formatCurrencyShort(e),padding:8},title:{display:!1}}},layout:{padding:10}},plugins:[b]},f={type:"line",data:{labels:s,datasets:[d,p]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1}},elements:{point:{radius:0,hoverRadius:0}},scales:{x:{beginAtZero:!1,border:{display:!0,color:"#0A5999",width:2},grid:{display:!1,drawOnChartArea:!1,drawBorder:!1,drawTicks:!1,offset:!1},title:{display:!0,text:"AGE",color:"#0A5999",padding:10,font:{size:8,weight:"bold"}},ticks:{display:!1}},y:{beginAtZero:!1,grid:{display:!0,color:"#CCEAF7",drawBorder:!1,drawTicks:!1,offset:!1},border:{display:!0,color:"#0A5999",width:2},ticks:{display:!1},title:{display:!1}}},layout:{padding:{top:0,right:0,bottom:0,left:1}}}};displayGoldLine&&(x.data.datasets.push(m),f.data.datasets.push(m)),chartInited?(chart.data.labels=s,chart.data.datasets=x.data.datasets,chart.options=x.options,chart.update("none"),overviewChart.data.labels=s,overviewChart.data.datasets=f.data.datasets,overviewChart.options=f.options,overviewChart.update("none")):(chart=new Chart(V,x),overviewChart=new Chart(g,f),V.canvas.addEventListener("mousemove",e=>{let t=chart.getElementsAtEventForMode(e,"index",{intersect:!1});if(t.length){let a=t[0],r=a.index,n=inputValues["current-age"]+r,s=chart.data.datasets[0].data[r],l=chart.data.datasets[1].data[r],c=chart.data.datasets[2]?.data[r]||0;chartElements.resultAge.textContent=n,chartElements.resultBtc.textContent=formatCurrency(s),chartElements.result60_40.textContent=formatCurrency(l),chartElements.resultRoth.textContent=formatCurrency(c),chartElements.resultDifference.textContent=formatCurrency(s-l),chartElements.resultsWrap.classList.remove("is--inactive")}else chartElements.resultsWrap.classList.add("is--inactive")}),V.canvas.addEventListener("mouseleave",()=>{chartElements.resultsWrap.classList.add("is--inactive")}),chartInited=!0)};
